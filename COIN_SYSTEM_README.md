# 🪙 PeiPlay 金幣系統

## 系統概述

PeiPlay 金幣系統是一個統一的儲值和消費平台，用戶可以通過儲值獲得金幣，然後使用金幣進行預約夥伴服務和贈送禮物。

## 🎯 核心特性

### 1. 統一儲值系統
- **1 金幣 = 1 元新台幣**
- 支援多種儲值套餐（100、500、1000、2000、5000、10000 金幣）
- 大量儲值可獲得贈送金幣
- 整合綠界金流，支援信用卡和超商付款

### 2. 金幣消費
- **預約夥伴服務**：使用金幣預約遊戲夥伴
- **贈送禮物**：在 Discord 頻道中贈送禮物給夥伴
- **即時餘額查詢**：隨時查看金幣餘額和交易記錄

### 3. 禮物系統
- 7 種不同價位的禮物（玫瑰、愛心、星星、皇冠、鑽石、火箭、彩虹）
- 夥伴可獲得 70% 的禮物收益
- 平台抽成 30%

## 🚀 快速開始

### 1. 資料庫遷移

```bash
# 應用資料庫遷移
npx prisma migrate dev --name add_coin_system

# 生成 Prisma 客戶端
npx prisma generate

# 創建禮物種子資料
node prisma/seed-gifts.js
```

### 2. 環境變數設定

```env
# .env.local
NEXTAUTH_URL=http://localhost:3000
API_BASE_URL=http://localhost:3000
```

### 3. 啟動服務

```bash
# 啟動 Next.js 應用
npm run dev

# 啟動 Discord Bot（需要安裝禮物指令）
cd discord-bot
python bot.py
```

## 📱 使用方式

### 儲值金幣

1. 訪問 `/recharge` 頁面
2. 選擇儲值套餐
3. 點擊「確認儲值」
4. 跳轉到綠界付款頁面
5. 完成付款後金幣立即到帳

### 預約夥伴

1. 訪問 `/booking` 頁面
2. 選擇夥伴和時段
3. 系統檢查金幣餘額
4. 確認預約，扣除相應金幣
5. 預約成功，等待夥伴確認

### 贈送禮物

在 Discord 預約頻道中使用以下指令：

```bash
# 查看可用禮物
!gifts

# 查看金幣餘額
!coins

# 贈送禮物
!gift @用戶 玫瑰
!gift @用戶 皇冠
!gift @用戶 鑽石
```

## 🗄️ 資料庫結構

### 主要表格

- **UserCoins**: 用戶金幣餘額
- **RechargeRecord**: 儲值記錄
- **CoinTransaction**: 金幣交易記錄
- **GiftItem**: 禮物定義
- **GiftRecord**: 禮物贈送記錄
- **PartnerEarnings**: 夥伴收益記錄

### 關聯關係

```
User (1) ←→ (1) UserCoins
User (1) ←→ (N) RechargeRecord
User (1) ←→ (N) CoinTransaction
User (1) ←→ (N) GiftRecord (作為發送者)
User (1) ←→ (N) GiftRecord (作為接收者)
User (1) ←→ (1) PartnerEarnings
```

## 🔧 API 端點

### 儲值相關

- `POST /api/recharge` - 創建儲值訂單
- `GET /api/recharge` - 獲取儲值記錄

### 金幣相關

- `GET /api/user/coins` - 獲取用戶金幣資訊

### 禮物相關

- `POST /api/gifts/send` - 贈送禮物
- `GET /api/gifts/list` - 獲取禮物列表

## 🎮 Discord Bot 指令

### 禮物指令

- `!gift @用戶 禮物名稱` - 贈送禮物
- `!coins` - 查看金幣餘額
- `!gifts` - 列出可用禮物

### 預約指令

- `!booking` - 查看預約狀態
- `!schedule` - 查看時程安排

## 💰 收益結算

### 夥伴收益

- 每個禮物的 70% 收益歸夥伴所有
- 收益累積到一定門檻後可申請結算
- 結算方式：銀行轉帳或 LINE Pay 個人轉帳

### 平台抽成

- 每個禮物的 30% 收益歸平台所有
- 用於系統維護和營運成本

## 🔒 安全機制

### 交易安全

- 所有金幣操作都使用資料庫事務
- 防止重複消費和餘額異常
- 完整的交易記錄追蹤

### 權限控制

- 只能在預約頻道中贈送禮物
- 只能贈送給預約關係中的用戶
- 需要足夠的金幣餘額才能消費

## 📊 監控和日誌

### 系統日誌

- 所有金幣操作都有詳細日誌
- 錯誤和異常情況會記錄到控制台
- 可追蹤每筆交易的完整流程

### 餘額監控

- 實時金幣餘額更新
- 交易前餘額檢查
- 異常餘額警告

## 🚨 故障排除

### 常見問題

1. **金幣餘額不更新**
   - 檢查付款回調是否正常
   - 確認資料庫連接狀態

2. **禮物贈送失敗**
   - 檢查金幣餘額是否足夠
   - 確認是否在預約頻道中

3. **Discord Bot 無回應**
   - 檢查 Bot 是否在線
   - 確認 API 端點是否可訪問

### 調試模式

```bash
# 啟用詳細日誌
DEBUG=* npm run dev

# 檢查資料庫狀態
npx prisma studio
```

## 🔮 未來規劃

### 短期目標

- [ ] 添加更多禮物類型
- [ ] 實現禮物特效動畫
- [ ] 添加禮物排行榜

### 長期目標

- [ ] 實現金幣轉帳功能
- [ ] 添加金幣投資理財
- [ ] 整合更多支付方式

## 📞 技術支援

如有技術問題，請聯繫開發團隊或查看 GitHub Issues。

---

**版本**: 1.0.0  
**更新日期**: 2025-01-03  
**維護者**: PeiPlay 開發團隊
