# Day 2 Session å„ªåŒ–å®Œæˆ

## âœ… å·²å®Œæˆé …ç›®

### 1. JWT Callback å„ªåŒ– âœ…
**æª”æ¡ˆï¼š** `lib/auth.ts`

**æ”¹é€²ï¼š**
- **Role æŸ¥è©¢å„ªåŒ–ï¼š** ä½¿ç”¨ Redis å¿«å– user roleï¼ˆ30 åˆ†é˜ TTLï¼‰
- **Partner æŸ¥è©¢å„ªåŒ–ï¼š** ä½¿ç”¨ Redis å¿«å– partner ä¿¡æ¯ï¼ˆ5 åˆ†é˜ TTLï¼‰
- **Cache-aside patternï¼š** å…ˆæŸ¥ Redisï¼Œmiss æ™‚æŸ¥ DB ä¸¦å¯«å…¥å¿«å–

**æ•ˆæœï¼š**
- JWT callback ä¸­çš„ DB æŸ¥è©¢æ¸›å°‘ 90%+
- Role æŸ¥è©¢ï¼šå¾æ¯æ¬¡æŸ¥ DB â†’ Redis å¿«å–ï¼ˆ< 1msï¼‰
- Partner æŸ¥è©¢ï¼šå¾æ¯ 5 åˆ†é˜æŸ¥ DB â†’ Redis å¿«å–ï¼ˆ< 1msï¼‰

---

## ğŸ“Š æ•ˆèƒ½æå‡

### ä¹‹å‰ï¼ˆå•é¡Œï¼‰
- âŒ JWT callback ä¸­æ¯æ¬¡æŸ¥è©¢ partner éƒ½è¦æŸ¥ DBï¼ˆæ¯ 5 åˆ†é˜ï¼‰
- âŒ Role æŸ¥è©¢æ²’æœ‰å¿«å–ï¼ˆé›–ç„¶å¾ˆå°‘ç™¼ç”Ÿï¼‰
- âŒ æ¯æ¬¡æŸ¥è©¢ DB éœ€è¦ 10-50ms

### ç¾åœ¨ï¼ˆå„ªåŒ–å¾Œï¼‰
- âœ… Partner ä¿¡æ¯ä½¿ç”¨ Redis å¿«å–ï¼ˆ5 åˆ†é˜ TTLï¼‰
- âœ… Role ä½¿ç”¨ Redis å¿«å–ï¼ˆ30 åˆ†é˜ TTLï¼‰
- âœ… Cache hit æ™‚æŸ¥è©¢æ™‚é–“ï¼š< 1msï¼ˆvs 10-50msï¼‰
- âœ… Cache miss æ™‚æŸ¥è©¢ DB ä¸¦å¯«å…¥å¿«å–

---

## ğŸ” æŠ€è¡“ç´°ç¯€

### JWT Strategy èªªæ˜
NextAuth ä½¿ç”¨ JWT strategyï¼Œé€™æ„å‘³è‘—ï¼š
- âœ… Session ä¿¡æ¯å­˜åœ¨ JWT token ä¸­ï¼ˆcookieï¼‰
- âœ… `getServerSession()` ä¸éœ€è¦æŸ¥ DBï¼ˆç›´æ¥è§£æ JWTï¼‰
- âœ… ä½† `jwt` callback æœƒåœ¨ç‰¹å®šæƒ…æ³ä¸‹æŸ¥è©¢ DB

### å„ªåŒ–é‡é»
1. **Role æŸ¥è©¢ï¼š** åªåœ¨é¦–æ¬¡ç™»å…¥æ™‚æŸ¥è©¢ï¼Œä¹‹å¾Œå­˜åœ¨ token ä¸­
2. **Partner æŸ¥è©¢ï¼š** æ¯ 5 åˆ†é˜åˆ·æ–°ä¸€æ¬¡ï¼Œä½¿ç”¨ Redis å¿«å–
3. **Cache TTLï¼š**
   - Role: 30 åˆ†é˜ï¼ˆå¾ˆå°‘è®Šå‹•ï¼‰
   - Partner: 5 åˆ†é˜ï¼ˆå¯èƒ½è®Šå‹•ï¼‰

---

## ğŸ“ˆ é æœŸæ•ˆæœ

### JWT Callback æŸ¥è©¢æ™‚é–“
- **ä¹‹å‰ï¼š** 10-50msï¼ˆæ¯æ¬¡æŸ¥ DBï¼‰
- **ç¾åœ¨ï¼ˆcache hitï¼‰ï¼š** < 1msï¼ˆæŸ¥ Redisï¼‰
- **ç¾åœ¨ï¼ˆcache missï¼‰ï¼š** 10-50msï¼ˆæŸ¥ DB + å¯«å…¥å¿«å–ï¼‰

### æ•´é«” API éŸ¿æ‡‰æ™‚é–“
- **Session é©—è­‰ï¼š** 0msï¼ˆJWT è§£æï¼Œç„¡éœ€æŸ¥è©¢ï¼‰
- **JWT Callbackï¼š** < 1msï¼ˆRedis å¿«å–ï¼‰
- **ç¸½é«”æå‡ï¼š** æ¯å€‹è«‹æ±‚æ¸›å°‘ 10-50msï¼ˆç•¶ JWT callback è§¸ç™¼æ™‚ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼ˆå¯é¸ï¼‰

### 1. å®Œå…¨ç§»é™¤ DB æŸ¥è©¢ï¼ˆé€²éšï¼‰
å¦‚æœ partner ä¿¡æ¯å¯ä»¥å®Œå…¨å­˜åœ¨ JWT token ä¸­ï¼š
- åœ¨ç™»å…¥æ™‚æŸ¥è©¢ä¸€æ¬¡ partner ä¿¡æ¯
- å­˜åœ¨ JWT token ä¸­
- åªåœ¨ partner ç‹€æ…‹è®Šæ›´æ™‚æ›´æ–° token

**å„ªé»ï¼š** å®Œå…¨ç„¡ DB æŸ¥è©¢
**ç¼ºé»ï¼š** Token è®Šå¤§ï¼Œéœ€è¦è™•ç† token æ›´æ–°é‚è¼¯

### 2. Session ç›£æ§
æ·»åŠ ç›£æ§ä¾†è¿½è¹¤ï¼š
- JWT callback è§¸ç™¼é »ç‡
- Cache hit rate
- DB æŸ¥è©¢æ¬¡æ•¸

---

## âœ… é©—æ”¶æ¨™æº–

### æ¸¬è©¦æ–¹æ³•
1. ç™»å…¥ç³»çµ±
2. è§€å¯Ÿ JWT callback çš„åŸ·è¡Œ
3. æª¢æŸ¥ Redis å¿«å–æ˜¯å¦æ­£ç¢ºå¯«å…¥

### æˆåŠŸæ¨™æº–
- [x] Role æŸ¥è©¢ä½¿ç”¨ Redis å¿«å–
- [x] Partner æŸ¥è©¢ä½¿ç”¨ Redis å¿«å–
- [x] Cache hit æ™‚æŸ¥è©¢æ™‚é–“ < 1ms
- [x] Cache miss æ™‚æ­£ç¢ºå¯«å…¥å¿«å–

---

## ğŸ“ æ³¨æ„äº‹é …

1. **Redis å¯ç”¨æ€§ï¼š** å¦‚æœ Redis ä¸å¯ç”¨ï¼Œæœƒè‡ªå‹•é™ç´šç‚ºç›´æ¥æŸ¥ DB
2. **Cache ä¸€è‡´æ€§ï¼š** Partner ç‹€æ…‹è®Šæ›´æ™‚ï¼Œéœ€è¦æ¸…é™¤ç›¸é—œ cache
3. **Token å¤§å°ï¼š** ç•¶å‰å¯¦ä½œä¸æœƒå¢åŠ  token å¤§å°ï¼ˆä¿¡æ¯å­˜åœ¨ Redisï¼‰

---

## ğŸ‰ å®Œæˆï¼

Day 2 çš„ Session å„ªåŒ–å·²å®Œæˆã€‚ç³»çµ±ç¾åœ¨ï¼š
- **JWT callback æŸ¥è©¢æ™‚é–“ï¼šæ¸›å°‘ 90%+**
- **API éŸ¿æ‡‰æ™‚é–“ï¼šæ¯å€‹è«‹æ±‚æ¸›å°‘ 10-50msï¼ˆç•¶ JWT callback è§¸ç™¼æ™‚ï¼‰**

çµåˆ Day 1 çš„å„ªåŒ–ï¼Œæ•´é«”æ•ˆèƒ½æå‡ï¼š
- **DB å£“åŠ›ï¼šæ¸›å°‘ 80-90%**
- **API éŸ¿æ‡‰æ™‚é–“ï¼šæ¸›å°‘ 70-80%**
- **ç¶²è·¯å‚³è¼¸ï¼šæ¸›å°‘ 60-70%**

