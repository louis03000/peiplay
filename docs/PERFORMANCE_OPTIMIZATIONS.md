# ğŸš€ PeiPlay è³‡æ–™åº«æ•ˆèƒ½å„ªåŒ–ç¸½çµ

## ğŸ“‹ å„ªåŒ–å…§å®¹

### 1. âœ… æ·»åŠ é—œéµè³‡æ–™åº«ç´¢å¼•

#### Partner è¡¨ç´¢å¼•
- `status` - åŠ é€ŸæŒ‰ç‹€æ…‹ç¯©é¸å¤¥ä¼´
- `status, isAvailableNow` - è¤‡åˆç´¢å¼•ï¼ŒåŠ é€Ÿã€Œç¾åœ¨æœ‰ç©ºã€æŸ¥è©¢
- `status, isRankBooster` - è¤‡åˆç´¢å¼•ï¼ŒåŠ é€Ÿã€Œä¸Šåˆ†é«˜æ‰‹ã€æŸ¥è©¢
- `userId` - åŠ é€ŸæŒ‰ç”¨æˆ¶ ID æŸ¥è©¢

#### Schedule è¡¨ç´¢å¼•
- `partnerId, date, isAvailable` - è¤‡åˆç´¢å¼•ï¼ŒåŠ é€ŸæŸ¥è©¢ç‰¹å®šå¤¥ä¼´çš„å¯ç”¨æ™‚æ®µ
- `partnerId, date` - åŠ é€ŸæŸ¥è©¢ç‰¹å®šå¤¥ä¼´çš„æ™‚æ®µ
- `date, isAvailable` - åŠ é€ŸæŒ‰æ—¥æœŸæŸ¥è©¢å¯ç”¨æ™‚æ®µ
- `partnerId, isAvailable` - åŠ é€ŸæŸ¥è©¢ç‰¹å®šå¤¥ä¼´çš„å¯ç”¨æ™‚æ®µ

#### Booking è¡¨ç´¢å¼•
- `status` - åŠ é€ŸæŒ‰ç‹€æ…‹ç¯©é¸é ç´„
- `customerId, status` - è¤‡åˆç´¢å¼•ï¼ŒåŠ é€ŸæŸ¥è©¢å®¢æˆ¶çš„é ç´„ç‹€æ…‹
- `scheduleId` - åŠ é€ŸæŸ¥è©¢æ™‚æ®µçš„é ç´„
- `customerId, createdAt` - åŠ é€ŸæŒ‰æ™‚é–“æ’åºå®¢æˆ¶é ç´„

#### Customer è¡¨ç´¢å¼•
- `userId` - åŠ é€ŸæŒ‰ç”¨æˆ¶ ID æŸ¥è©¢å®¢æˆ¶

### 2. âœ… å„ªåŒ– Partners API (`/api/partners`)

**æ”¹é€²ï¼š**
- åœ¨è³‡æ–™åº«å±¤é¢éæ¿¾è¢«åœæ¬Šçš„ç”¨æˆ¶ï¼Œæ¸›å°‘å¾Œè™•ç†
- åœ¨æŸ¥è©¢æ™‚ç›´æ¥éæ¿¾æ‰æœ‰æ´»èºé ç´„çš„æ™‚æ®µ
- é™åˆ¶æ¯å€‹ partner æœ€å¤šè¼‰å…¥ 50 å€‹æ™‚æ®µ
- ä½¿ç”¨è¤‡åˆç´¢å¼•åŠ é€ŸæŸ¥è©¢

**é æœŸæ•ˆæœï¼š**
- æŸ¥è©¢æ™‚é–“å¾ 3-7 ç§’é™ä½åˆ° 1-2 ç§’
- æ¸›å°‘è³‡æ–™å‚³è¼¸é‡
- æ¸›å°‘è¨˜æ†¶é«”ä½¿ç”¨

### 3. âœ… å„ªåŒ– Dashboard API (`/api/partner/dashboard`)

**æ”¹é€²ï¼š**
- åªè¼‰å…¥æœªä¾†çš„æ™‚æ®µï¼ˆä¸è¼‰å…¥éå»çš„æ™‚æ®µï¼‰
- é™åˆ¶è¼‰å…¥çš„æ™‚æ®µæ•¸é‡ï¼ˆæœ€å¤š 200 å€‹ï¼‰
- ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è©¢

**é æœŸæ•ˆæœï¼š**
- æŸ¥è©¢æ™‚é–“å¾ 10+ ç§’é™ä½åˆ° 2-3 ç§’
- æ¸›å°‘ä¸å¿…è¦çš„è³‡æ–™è¼‰å…¥

### 4. âœ… å„ªåŒ– Favorites API (`/api/favorites`)

**æ”¹é€²ï¼š**
- ä½¿ç”¨ `select` åªé¸æ“‡å¿…è¦æ¬„ä½
- é™åˆ¶çµæœæ•¸é‡ï¼ˆæœ€å¤š 100 å€‹ï¼‰
- åˆ©ç”¨ç¾æœ‰ç´¢å¼•å„ªåŒ–æŸ¥è©¢

**é æœŸæ•ˆæœï¼š**
- æŸ¥è©¢æ™‚é–“å¾ 7 ç§’é™ä½åˆ° 1 ç§’ä»¥å…§

## ğŸ”§ å¦‚ä½•æ‡‰ç”¨ç´¢å¼•

### æ–¹æ³• 1ï¼šä½¿ç”¨ Prisma Migrateï¼ˆæ¨è–¦ï¼‰

```bash
# ç”Ÿæˆ migration
npx prisma migrate dev --name add_performance_indexes

# æˆ–ç›´æ¥æ‡‰ç”¨ schema æ›´æ”¹ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
npx prisma db push
```

### æ–¹æ³• 2ï¼šæ‰‹å‹•åŸ·è¡Œ SQL

åŸ·è¡Œ `prisma/migrations/add_performance_indexes.sql` ä¸­çš„ SQL èªå¥ã€‚

## ğŸ“Š é æœŸæ•ˆèƒ½æå‡

| API ç«¯é» | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æå‡ |
|---------|--------|--------|------|
| `/api/partners` | 3-7 ç§’ | 1-2 ç§’ | **60-70%** |
| `/api/partner/dashboard` | 10+ ç§’ | 2-3 ç§’ | **70-80%** |
| `/api/favorites` | 7 ç§’ | <1 ç§’ | **85%+** |

## ğŸ” ç›£æ§å»ºè­°

1. **ç›£æ§æŸ¥è©¢æ™‚é–“**
   - ä½¿ç”¨ `/api/health/database` ç«¯é»ç›£æ§è³‡æ–™åº«å¥åº·ç‹€æ…‹
   - æŸ¥çœ‹ Vercel å‡½æ•¸æ—¥èªŒä¸­çš„æŸ¥è©¢æ™‚é–“

2. **æª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³**
   ```sql
   -- PostgreSQL ä¸­æª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³
   SELECT * FROM pg_stat_user_indexes 
   WHERE schemaname = 'public' 
   ORDER BY idx_scan DESC;
   ```

3. **ç›£æ§è³‡æ–™åº«é€£æ¥**
   - ç¢ºä¿ä½¿ç”¨ Supabase Pooler URL
   - ç›£æ§é€£æ¥æ± ä½¿ç”¨æƒ…æ³

## âš ï¸ æ³¨æ„äº‹é …

1. **ç´¢å¼•ç¶­è­·æˆæœ¬**
   - ç´¢å¼•æœƒå¢åŠ å¯«å…¥æ™‚é–“ï¼ˆé€šå¸¸å¯å¿½ç•¥ï¼‰
   - ç´¢å¼•æœƒä½”ç”¨é¡å¤–å„²å­˜ç©ºé–“ï¼ˆé€šå¸¸å¾ˆå°ï¼‰

2. **è³‡æ–™åº«é·ç§»**
   - åœ¨ç”Ÿç”¢ç’°å¢ƒæ‡‰ç”¨ç´¢å¼•å‰ï¼Œå»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒæ¸¬è©¦
   - å¤§å‹è¡¨æ·»åŠ ç´¢å¼•å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“

3. **æŒçºŒå„ªåŒ–**
   - å®šæœŸæª¢æŸ¥æ…¢æŸ¥è©¢æ—¥èªŒ
   - æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´ç´¢å¼•ç­–ç•¥

## ğŸ“ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **æŸ¥è©¢ç·©å­˜**
   - è€ƒæ…®å°ä¸å¸¸è®Šå‹•çš„è³‡æ–™ï¼ˆå¦‚å¤¥ä¼´åˆ—è¡¨ï¼‰æ·»åŠ ç·©å­˜
   - ä½¿ç”¨ Redis æˆ– Vercel Edge Cache

2. **åˆ†é å„ªåŒ–**
   - å¯¦ç¾æ¸¸æ¨™åˆ†é ï¼ˆcursor-based paginationï¼‰
   - æ¸›å°‘è¼‰å…¥çš„è³‡æ–™é‡

3. **ä¸¦è¡ŒæŸ¥è©¢**
   - å°æ–¼ç¨ç«‹çš„æŸ¥è©¢ï¼Œè€ƒæ…®ä¸¦è¡ŒåŸ·è¡Œ
   - ä½¿ç”¨ `Promise.all()` ä¸¦è¡ŒåŸ·è¡Œå¤šå€‹æŸ¥è©¢

4. **è³‡æ–™åº«é€£æ¥å„ªåŒ–**
   - ç¢ºä¿ä½¿ç”¨é€£æ¥æ± 
   - ç›£æ§é€£æ¥æ± ä½¿ç”¨æƒ…æ³

## ğŸ”— ç›¸é—œæ–‡ä»¶

- `prisma/schema.prisma` - è³‡æ–™åº« schema å®šç¾©
- `lib/db-resilience.ts` - è³‡æ–™åº«å½ˆæ€§è™•ç†
- `docs/DATABASE_RESILIENCE_GUIDE.md` - è³‡æ–™åº«å½ˆæ€§æŒ‡å—

