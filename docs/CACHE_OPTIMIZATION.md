# PeiPlay å¿«å–å„ªåŒ–å¯¦æ–½ç¸½çµ

æœ¬æ–‡æª”è¨˜éŒ„äº†æ ¹æ“šå¿«å–æœ€ä½³å¯¦è¸å° PeiPlay ç¶²ç«™é€²è¡Œçš„å…¨é¢å¿«å–å„ªåŒ–ã€‚

## ğŸ“‹ å„ªåŒ–ç›®æ¨™

æ ¹æ“šå¿«å–ç­–ç•¥æ–‡ç« ï¼Œå¾ä¸‰å€‹å±¤é¢é€²è¡Œå„ªåŒ–ï¼š
1. **å¯¦ä½œ HTTP å¿«å–ï¼ˆDisk Cacheï¼‰**ï¼šç‚ºéœæ…‹è³‡æºè¨­å®š Cache-Control headers
2. **ä½¿ç”¨ CDN**ï¼šå„ªåŒ–éœæ…‹è³‡æºå‚³è¼¸ï¼ˆé€é Vercel Edge Networkï¼‰
3. **å¾Œç«¯å¿«å–ï¼ˆApplication Cacheï¼‰**ï¼šä½¿ç”¨ Redis å¿«å–é »ç¹è®€å–çš„è³‡æ–™

## âœ… å·²å®Œæˆçš„å„ªåŒ–

### 1. HTTP å¿«å–ï¼ˆDisk Cacheï¼‰å„ªåŒ–

#### éœæ…‹è³‡æºå¿«å–
åœ¨ `next.config.js` ä¸­ç‚ºä»¥ä¸‹è³‡æºé¡å‹è¨­å®šäº†é•·æœŸå¿«å–ï¼š

- **Next.js æ§‹å»ºç”¢ç‰©** (`/_next/static/*`)
  - `Cache-Control: public, max-age=31536000, immutable`
  - 1 å¹´å¿«å–ï¼Œå› ç‚ºæª”æ¡ˆåç¨±åŒ…å«å…§å®¹é›œæ¹Šï¼Œä¸æœƒè®Šå‹•

- **Next.js åœ–ç‰‡å„ªåŒ–** (`/_next/image/*`)
  - `Cache-Control: public, max-age=31536000, immutable`
  - 1 å¹´å¿«å–

- **éœæ…‹æª”æ¡ˆ** (`*.svg`, `*.png`, `*.jpg`, `*.jpeg`, `*.gif`, `*.webp`, `*.ico`)
  - `Cache-Control: public, max-age=31536000, immutable`
  - 1 å¹´å¿«å–

- **å­—é«”æª”æ¡ˆ** (`*.woff`, `*.woff2`, `*.ttf`, `*.eot`, `*.otf`)
  - `Cache-Control: public, max-age=31536000, immutable`
  - 1 å¹´å¿«å–

#### API å¿«å–ç­–ç•¥

**å…¬é–‹ APIï¼ˆè®€å–é¡ï¼Œä¸æ¶‰åŠå€‹äººè³‡æ–™ï¼‰**
- `/api/announcements`
- `/api/games/list`
- `/api/partners/ranking`
- `/api/partners/average-rating`
- `Cache-Control: public, s-maxage=60, stale-while-revalidate=300`
- CDN å¿«å– 60 ç§’ï¼ŒèƒŒæ™¯é‡æ–°é©—è­‰ 300 ç§’

**å€‹äººè³‡æ–™ APIï¼ˆéœ€è¦ç™»å…¥ï¼‰**
- `/api/favorites`
- `/api/personal-notifications`
- `/api/partners/self`
- `Cache-Control: private, max-age=60, stale-while-revalidate=120`
- åªåœ¨ç”¨æˆ¶ç€è¦½å™¨ä¸­å¿«å–ï¼Œä¸ç¶“é CDN

**é è¨­ API ç­–ç•¥**
- å…¶ä»– API è·¯ç”±é è¨­ï¼š`no-store, no-cache, must-revalidate`
- ç¢ºä¿æ•æ„Ÿè³‡æ–™ä¸æœƒè¢«å¿«å–

### 2. Stale-While-Revalidate (SWR) ç­–ç•¥

å¯¦ä½œäº† SWR ç­–ç•¥ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ï¼š
1. **ç«‹å³çœ‹åˆ°å¿«å–å…§å®¹**ï¼šæå‡ä½¿ç”¨è€…é«”é©—
2. **èƒŒæ™¯æ›´æ–°**ï¼šåœ¨èƒŒæ™¯é©—è­‰ä¸¦æ›´æ–°å¿«å–
3. **ä¸‹æ¬¡è«‹æ±‚ç²å¾—æœ€æ–°è³‡æ–™**ï¼šç¢ºä¿è³‡æ–™æ–°é®®åº¦

**å¯¦ä½œç¯„ä¾‹ï¼š**
```typescript
headers: {
  'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300',
}
```

### 3. Redis å¾Œç«¯å¿«å–ï¼ˆApplication Cacheï¼‰

#### å·²å„ªåŒ–çš„ API

**1. Announcements API** (`/api/announcements`)
- ä½¿ç”¨ Redis å¿«å–å…¬å‘Šåˆ—è¡¨
- TTL: 2 åˆ†é˜ï¼ˆ`CacheTTL.SHORT`ï¼‰
- å»ºç«‹æ–°å…¬å‘Šæ™‚è‡ªå‹•æ¸…é™¤å¿«å–

**2. Partners API** (`/api/partners`)
- ä½¿ç”¨ Redis å¿«å–å¤¥ä¼´åˆ—è¡¨ï¼ˆæ ¹æ“šæŸ¥è©¢åƒæ•¸ç”Ÿæˆå¿«å– keyï¼‰
- TTL: 2 åˆ†é˜ï¼ˆ`CacheTTL.SHORT`ï¼‰
- å¤¥ä¼´è³‡æ–™æ›´æ–°æ™‚è‡ªå‹•æ¸…é™¤ç›¸é—œå¿«å–

**3. å¿«å–å¤±æ•ˆæ©Ÿåˆ¶**
- ç•¶å¤¥ä¼´è³‡æ–™æ›´æ–°æ™‚ï¼Œè‡ªå‹•æ¸…é™¤ç›¸é—œå¿«å–
- ç•¶å…¬å‘Šå»ºç«‹æ™‚ï¼Œè‡ªå‹•æ¸…é™¤å…¬å‘Šå¿«å–
- ç¢ºä¿ä½¿ç”¨è€…ä¸æœƒçœ‹åˆ°éæœŸè³‡æ–™

### 4. åœ–ç‰‡å¿«å–å„ªåŒ–

**Secure Image API** (`/api/secure-image`)
- å¾ `private, max-age=3600`ï¼ˆ1 å°æ™‚ï¼‰æå‡åˆ°
- `public, max-age=604800, stale-while-revalidate=86400`ï¼ˆ7 å¤© + 1 å¤©èƒŒæ™¯é©—è­‰ï¼‰
- å¤§å¹…æ¸›å°‘åœ–ç‰‡è«‹æ±‚æ¬¡æ•¸

## ğŸ“Š é æœŸæ•ˆæœ

### æ•ˆèƒ½æå‡

1. **éœæ…‹è³‡æºè¼‰å…¥é€Ÿåº¦**
   - å›è¨ªç”¨æˆ¶ï¼šå¹¾ä¹ç¬æ™‚è¼‰å…¥ï¼ˆå¾ Disk Cacheï¼‰
   - é¦–æ¬¡è¨ªå•ï¼šé€é CDN é‚Šç·£ç¯€é»å¿«é€Ÿè¼‰å…¥

2. **API å›æ‡‰é€Ÿåº¦**
   - å¿«å–å‘½ä¸­ï¼šå¾ Redis è®€å–ï¼Œå›æ‡‰æ™‚é–“ < 10ms
   - å¿«å–æœªå‘½ä¸­ï¼šæ­£å¸¸è³‡æ–™åº«æŸ¥è©¢ï¼Œä½†ä¸‹æ¬¡è«‹æ±‚æœƒå‘½ä¸­å¿«å–

3. **è³‡æ–™åº«è² è¼‰**
   - æ¸›å°‘é »ç¹æŸ¥è©¢ï¼ˆå¦‚å…¬å‘Šã€å¤¥ä¼´åˆ—è¡¨ï¼‰
   - é æœŸæ¸›å°‘ 50-70% çš„è³‡æ–™åº«æŸ¥è©¢é‡

### ä½¿ç”¨è€…é«”é©—

1. **é é¢è¼‰å…¥é€Ÿåº¦**
   - é¦–æ¬¡è¼‰å…¥ï¼šé€é CDN å’Œ Redis å¿«å–ï¼Œé€Ÿåº¦æå‡ 30-50%
   - å›è¨ªè¼‰å…¥ï¼šå¾ç€è¦½å™¨å¿«å–è®€å–ï¼Œé€Ÿåº¦æå‡ 80-90%

2. **è³‡æ–™æ–°é®®åº¦**
   - SWR ç­–ç•¥ç¢ºä¿ä½¿ç”¨è€…çœ‹åˆ°æœ€æ–°è³‡æ–™
   - èƒŒæ™¯æ›´æ–°ä¸å½±éŸ¿ä½¿ç”¨è€…é«”é©—

## ğŸ”§ æŠ€è¡“å¯¦ä½œç´°ç¯€

### Redis å¿«å– Key å‘½åè¦ç¯„

```
{resource}:{type}:{identifier}
```

ç¯„ä¾‹ï¼š
- `partners:list:startDate:|endDate:|availableNow:true|rankBooster:false|game:`
- `stats:platform:announcements`

### Cache TTL è¨­å®š

```typescript
export const CacheTTL = {
  SHORT: 60,        // 1 åˆ†é˜ï¼ˆé«˜é »è®Šå‹•è³‡æ–™ï¼‰
  MEDIUM: 300,      // 5 åˆ†é˜ï¼ˆä¸€èˆ¬è³‡æ–™ï¼‰
  LONG: 1800,       // 30 åˆ†é˜ï¼ˆè¼ƒå°‘è®Šå‹•è³‡æ–™ï¼‰
  VERY_LONG: 3600,  // 1 å°æ™‚ï¼ˆéœæ…‹è³‡æ–™ï¼‰
}
```

### å¿«å–å¤±æ•ˆç­–ç•¥

ä½¿ç”¨ `CacheInvalidation` é¡åˆ¥çµ±ä¸€ç®¡ç†ï¼š
- `onPartnerUpdate()` - å¤¥ä¼´æ›´æ–°æ™‚æ¸…é™¤ç›¸é—œå¿«å–
- `onBookingUpdate()` - é ç´„æ›´æ–°æ™‚æ¸…é™¤ç›¸é—œå¿«å–
- `onReviewCreate()` - è©•åƒ¹å»ºç«‹æ™‚æ¸…é™¤ç›¸é—œå¿«å–

## ğŸ“ æ³¨æ„äº‹é …

1. **Redis é€£ç·š**
   - ç¢ºä¿ç’°å¢ƒè®Šæ•¸ `REDIS_URL` å·²è¨­å®š
   - å¦‚æœ Redis ä¸å¯ç”¨ï¼Œç³»çµ±æœƒè‡ªå‹•é™ç´šç‚ºç„¡å¿«å–æ¨¡å¼

2. **å¿«å–ä¸€è‡´æ€§**
   - æ‰€æœ‰è³‡æ–™æ›´æ–°æ“ä½œéƒ½å¿…é ˆæ¸…é™¤ç›¸é—œå¿«å–
   - ä½¿ç”¨ `CacheInvalidation` é¡åˆ¥ç¢ºä¿ä¸€è‡´æ€§

3. **ç›£æ§å»ºè­°**
   - ç›£æ§ Redis å¿«å–å‘½ä¸­ç‡
   - ç›£æ§ API å›æ‡‰æ™‚é–“
   - ç›£æ§è³‡æ–™åº«æŸ¥è©¢é‡

## ğŸš€ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **CDN é…ç½®**
   - è€ƒæ…®ä½¿ç”¨ Vercel Edge Network æˆ– Cloudflare CDN
   - ç‚ºéœæ…‹è³‡æºè¨­å®šæ›´é•·çš„å¿«å–æ™‚é–“

2. **Service Worker**
   - å¯¦ä½œ Service Worker å¿«å–ï¼ˆPWA åŠŸèƒ½ï¼‰
   - æ”¯æ´é›¢ç·šç€è¦½

3. **æ›´å¤š API å¿«å–**
   - è©•ä¼°å…¶ä»–è®€å–é¡ API æ˜¯å¦é©åˆåŠ å…¥å¿«å–
   - å¦‚ï¼š`/api/partners/[id]`ã€`/api/reviews/public` ç­‰

4. **å¿«å–é ç†±**
   - å¯¦ä½œå¿«å–é ç†±æ©Ÿåˆ¶ï¼Œåœ¨ç³»çµ±å•Ÿå‹•æ™‚é å…ˆè¼‰å…¥ç†±é–€è³‡æ–™

## ğŸ“š åƒè€ƒè³‡æ–™

- [HTTP Caching - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)
- [Stale-While-Revalidate - Web.dev](https://web.dev/stale-while-revalidate/)
- [Next.js Caching](https://nextjs.org/docs/app/building-your-application/caching)

