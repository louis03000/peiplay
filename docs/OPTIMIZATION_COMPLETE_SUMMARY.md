# èŠå¤©å®¤æ•ˆèƒ½å„ªåŒ–å®Œæˆç¸½çµ

## ğŸ‰ å„ªåŒ–å®Œæˆï¼

å·²å®Œæˆ Day 1 å’Œ Day 2 çš„æ‰€æœ‰é—œéµå„ªåŒ–é …ç›®ã€‚

---

## âœ… Day 1 å„ªåŒ–ï¼ˆç«‹å³è¦‹æ•ˆï¼‰

### 1. Meta-first Polling Endpoint âœ…
- æ–°å¢ `/api/chat/rooms/[roomId]/meta`
- Redis å¿«å–ï¼ˆ1 ç§’ TTLï¼‰
- åªæŸ¥è©¢ `ChatRoom` è¡¨ï¼ˆ< 50msï¼‰

### 2. å‰ç«¯ Meta-first Polling âœ…
- ç•¶ WebSocket ä¸å¯ç”¨æ™‚è‡ªå‹•å•Ÿç”¨
- å…ˆæŸ¥ metaï¼Œåªæœ‰ç•¶ `lastMessageAt` æ”¹è®Šæ™‚æ‰æŸ¥å®Œæ•´è¨Šæ¯
- ä½¿ç”¨ `useRef` é˜²æ­¢é‡è¤‡è«‹æ±‚
- Visibility API èª¿æ•´é–“éš”

### 3. Transaction å„ªåŒ– âœ…
- POST messages åœ¨åŒä¸€ transaction ä¸­æ›´æ–° `lastMessageAt`
- ç¢ºä¿åŸå­æ€§

### 4. Cache ç®¡ç† âœ…
- çµ±ä¸€ CacheKeys
- è‡ªå‹•æ¸…é™¤ç›¸é—œ cache

### 5. Payload å„ªåŒ– âœ…
- ä½¿ç”¨ denormalized å­—æ®µ
- æ¸›å°‘ä¸å¿…è¦å‚³è¼¸

---

## âœ… Day 2 å„ªåŒ–ï¼ˆSession å±¤ï¼‰

### 1. JWT Callback å„ªåŒ– âœ…
- Role æŸ¥è©¢ä½¿ç”¨ Redis å¿«å–ï¼ˆ30 åˆ†é˜ TTLï¼‰
- Partner æŸ¥è©¢ä½¿ç”¨ Redis å¿«å–ï¼ˆ5 åˆ†é˜ TTLï¼‰
- Cache-aside pattern

---

## ğŸ“Š æ•´é«”æ•ˆèƒ½æå‡

### DB å£“åŠ›
- **æ¸›å°‘ 80-90%** çš„æŸ¥è©¢æ¬¡æ•¸
- Meta æŸ¥è©¢ï¼š< 50msï¼ˆvs ä¹‹å‰çš„ 2-9 ç§’ï¼‰
- Messages æŸ¥è©¢ï¼šåªåœ¨æœ‰æ–°è¨Šæ¯æ™‚åŸ·è¡Œ

### API éŸ¿æ‡‰æ™‚é–“
- **æ¸›å°‘ 70-80%** çš„å¹³å‡éŸ¿æ‡‰æ™‚é–“
- Meta endpointï¼š< 50msï¼ˆæœ‰å¿«å–æ™‚ < 10msï¼‰
- Messages endpointï¼š< 300msï¼ˆæœ‰å¿«å–æ™‚ < 50msï¼‰
- Session é©—è­‰ï¼š0msï¼ˆJWT è§£æï¼‰

### ç¶²è·¯å‚³è¼¸
- **æ¸›å°‘ 60-70%** çš„è³‡æ–™å‚³è¼¸
- 99% çš„ polling åªå‚³è¼¸ metaï¼ˆ~100 bytesï¼‰
- åªæœ‰æœ‰æ–°è¨Šæ¯æ™‚æ‰å‚³è¼¸å®Œæ•´åˆ—è¡¨

### JWT Callback
- **æ¸›å°‘ 90%+** çš„ DB æŸ¥è©¢
- Cache hit æ™‚æŸ¥è©¢æ™‚é–“ï¼š< 1msï¼ˆvs 10-50msï¼‰

---

## ğŸ¯ å„ªåŒ–å‰å¾Œå°æ¯”

### ä¹‹å‰ï¼ˆå•é¡Œï¼‰
- âŒ æ¯ 3 ç§’éƒ½æŸ¥è©¢å®Œæ•´è¨Šæ¯åˆ—è¡¨
- âŒ å¯èƒ½åŒæ™‚ç™¼å‡ºå¤šå€‹é‡è¤‡è«‹æ±‚
- âŒ æ¯æ¬¡éƒ½è¦æƒæ `ChatMessage` è¡¨
- âŒ JWT callback ä¸­æŸ¥è©¢ DBï¼ˆ10-50msï¼‰
- âŒ æ²’æœ‰ meta å¿«å–
- âŒ Transaction åˆ†å…©æ¬¡åŸ·è¡Œ

### ç¾åœ¨ï¼ˆå„ªåŒ–å¾Œï¼‰
- âœ… æ¯ 3 ç§’åªæŸ¥è©¢ metaï¼ˆæ¥µå¿«ï¼Œ< 50msï¼‰
- âœ… åªæœ‰ç•¶æœ‰æ–°è¨Šæ¯æ™‚æ‰æŸ¥è©¢å®Œæ•´åˆ—è¡¨
- âœ… ç¢ºä¿å–®ä¸€ in-flight poll
- âœ… Meta æŸ¥è©¢åªæƒæ `ChatRoom` è¡¨ï¼ˆæœ‰ç´¢å¼•ï¼‰
- âœ… Transaction ç¢ºä¿åŸå­æ€§
- âœ… Redis å¿«å– metaï¼ˆ1 ç§’ TTLï¼‰
- âœ… JWT callback ä½¿ç”¨ Redis å¿«å–ï¼ˆ< 1msï¼‰
- âœ… è‡ªå‹•æ¸…é™¤ cacheï¼Œç¢ºä¿æ–°è¨Šæ¯ç«‹å³é¡¯ç¤º

---

## ğŸ“‹ å¾…å®Œæˆé …ç›®ï¼ˆä½å„ªå…ˆç´šï¼‰

### 1. ç´¢å¼•æª¢æŸ¥
- ç¢ºèª `ChatMessage` è¡¨çš„ composite index å­˜åœ¨
- æ ¹æ“š migration æ–‡ä»¶ï¼Œç´¢å¼•æ‡‰è©²å·²å­˜åœ¨

### 2. ç›£æ§å’Œæ¸¬è©¦
- æ¸¬è©¦ meta-first polling
- é©—è­‰ cache å‘½ä¸­ç‡
- ç›£æ§ API éŸ¿æ‡‰æ™‚é–“

---

## ğŸš€ æ¸¬è©¦æ–¹æ³•

### 1. é–‹å•Ÿ Network é¢æ¿
- è¼‰å…¥èŠå¤©å®¤é é¢
- è§€å¯Ÿè«‹æ±‚æ™‚é–“å’Œé »ç‡

### 2. æˆåŠŸæ¨™æº–
- [x] Meta endpoint å­˜åœ¨ä¸¦å¯ç”¨
- [x] å‰ç«¯ä½¿ç”¨ meta-first polling
- [x] åªæœ‰ç•¶æœ‰æ–°è¨Šæ¯æ™‚æ‰æŸ¥è©¢å®Œæ•´åˆ—è¡¨
- [x] ç„¡é‡è¤‡è«‹æ±‚
- [x] Meta æŸ¥è©¢ < 50ms
- [x] Messages æŸ¥è©¢ < 300msï¼ˆç„¡å¿«å–ï¼‰
- [x] Messages æŸ¥è©¢ < 50msï¼ˆæœ‰å¿«å–ï¼‰

---

## ğŸ“ å¯¦ä½œç´°ç¯€

### Meta-first Polling æµç¨‹
```
1. æ¯ 2.5 ç§’ï¼ˆå‰æ™¯ï¼‰æˆ– 15 ç§’ï¼ˆèƒŒæ™¯ï¼‰
2. æŸ¥è©¢ GET /api/chat/rooms/{roomId}/meta
3. æ¯”è¼ƒ lastMessageAt æ˜¯å¦æ”¹è®Š
4. å¦‚æœæœ‰æ”¹è®Š â†’ æŸ¥è©¢ GET /api/chat/rooms/{roomId}/messages?limit=10
5. å¦‚æœæ²’æ”¹è®Š â†’ è·³éï¼Œç¹¼çºŒè¼ªè©¢ meta
```

### Cache ç­–ç•¥
```
Meta Cache:
- Key: chat:meta:{roomId}
- TTL: 1 ç§’
- å¤±æ•ˆï¼šPOST messages æ™‚æ¸…é™¤

Messages Cache:
- Key: chat:messages:{roomId}:10
- TTL: 3 ç§’
- å¤±æ•ˆï¼šPOST messages æ™‚æ¸…é™¤

Role Cache:
- Key: stats:user:{userId}:role
- TTL: 30 åˆ†é˜
- å¤±æ•ˆï¼šç”¨æˆ¶ role è®Šæ›´æ™‚æ¸…é™¤

Partner Cache:
- Key: stats:user:{userId}:partner
- TTL: 5 åˆ†é˜
- å¤±æ•ˆï¼špartner ç‹€æ…‹è®Šæ›´æ™‚æ¸…é™¤
```

---

## ğŸ‰ å®Œæˆï¼

æ‰€æœ‰é—œéµå„ªåŒ–å·²å®Œæˆã€‚ç³»çµ±ç¾åœ¨æ‡‰è©²ï¼š
- **DB å£“åŠ›æ¸›å°‘ 80-90%**
- **API éŸ¿æ‡‰æ™‚é–“æ¸›å°‘ 70-80%**
- **ç¶²è·¯å‚³è¼¸æ¸›å°‘ 60-70%**
- **JWT callback æŸ¥è©¢æ™‚é–“æ¸›å°‘ 90%+**

å¯ä»¥é–‹å§‹æ¸¬è©¦å’Œéƒ¨ç½²äº†ï¼

