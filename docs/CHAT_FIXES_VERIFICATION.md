# âœ… èŠå¤©å®¤å„ªåŒ–ä¿®å¾© - é©—è­‰æ¸…å–®

## ğŸ” ä¿®å¾©é …ç›®æª¢æŸ¥

### âœ… 1. Cache Key çµ±ä¸€

**ä¿®å¾©å…§å®¹**ï¼š
- Cache key æ”¹ç‚ºï¼š`messages:${roomId}:latest:30`
- æ‰€æœ‰ç”¨æˆ¶å…±ç”¨åŒä¸€ä»½ cache
- ä¸åŒ…å« userId

**é©—è­‰æ–¹æ³•**ï¼š
```bash
# æ‰“é–‹ Networkï¼Œæª¢æŸ¥ messages API
# ç¬¬ä¸€æ¬¡è«‹æ±‚ï¼šæ‡‰è©²çœ‹åˆ° X-Cache: MISSï¼Œæ™‚é–“å¯èƒ½è¼ƒé•·
# ç¬¬äºŒæ¬¡è«‹æ±‚ï¼ˆåŒä¸€èŠå¤©å®¤ï¼‰ï¼šæ‡‰è©²çœ‹åˆ° X-Cache: HITï¼Œæ™‚é–“ < 100ms
```

**é æœŸçµæœ**ï¼š
- Cache hit æ™‚ï¼šResponse time < 100ms
- Cache miss æ™‚ï¼šResponse time < 300msï¼ˆå–æ±ºæ–¼ DBï¼‰

---

### âœ… 2. ç¦æ­¢ JOIN

**ä¿®å¾©å…§å®¹**ï¼š
- GET /messages åªæŸ¥è©¢ `messages` è¡¨
- ä½¿ç”¨ denormalized å­—æ®µï¼ˆsenderName, senderAvatarUrlï¼‰
- å®Œå…¨ç§»é™¤ JOIN users çš„é‚è¼¯

**é©—è­‰æ–¹æ³•**ï¼š
```sql
-- æª¢æŸ¥æŸ¥è©¢è¨ˆåŠƒ
EXPLAIN ANALYZE
SELECT id, content, "senderName", "senderAvatarUrl", "createdAt"
FROM "ChatMessage"
WHERE "roomId" = 'your-room-id'
ORDER BY "createdAt" DESC
LIMIT 30;
```

**é æœŸçµæœ**ï¼š
- åªæœ‰ Index Scanï¼Œæ²’æœ‰ JOIN
- Execution Time < 100ms

---

### âœ… 3. é¦–å±åª Fetch Messages

**ä¿®å¾©å…§å®¹**ï¼š
- èŠå¤©å®¤è³‡è¨Šå»¶å¾Œ 500ms è¼‰å…¥
- create-for-my-bookings å»¶å¾Œ 1 ç§’
- å…¶ä»– API ä¸é˜»å¡é¦–å±

**é©—è­‰æ–¹æ³•**ï¼š
1. æ‰“é–‹ Network
2. é€²å…¥èŠå¤©å®¤
3. æª¢æŸ¥ API è¼‰å…¥é †åº

**é æœŸçµæœ**ï¼š
- messages API æœ€å…ˆè¼‰å…¥
- å…¶ä»– API å»¶å¾Œè¼‰å…¥
- é¦–å±ç«‹å³é¡¯ç¤ºï¼ˆ< 500msï¼‰

---

### âœ… 4. Socket å–®ä¾‹

**ä¿®å¾©å…§å®¹**ï¼š
- æ•´å€‹ç¶²ç«™åªæœ‰ä¸€æ¢ socket é€£ç·š
- ä½¿ç”¨ `globalSocket` å–®ä¾‹
- åˆ‡æ›æˆ¿é–“æ™‚åª emit `room:join/leave`ï¼Œä¸é‡æ–°é€£æ¥

**é©—è­‰æ–¹æ³•**ï¼š
1. æ‰“é–‹ Network â†’ WS æ¨™ç±¤
2. é€²å…¥èŠå¤©å®¤
3. åˆ‡æ›æˆ¿é–“
4. æª¢æŸ¥ WebSocket é€£ç·šæ•¸é‡

**é æœŸçµæœ**ï¼š
- åªæœ‰ 1 æ¢ WebSocket é€£ç·š
- åˆ‡æ›æˆ¿é–“æ™‚ä¸é‡æ–°é€£æ¥

---

### âœ… 5. èˆŠè¨Šæ¯é¡¯ç¤ºã€ŒæœªçŸ¥ç”¨æˆ¶ã€

**ä¿®å¾©å…§å®¹**ï¼š
- é€™æ˜¯é æœŸè¡Œç‚ºï¼Œä¸æ˜¯ bug
- èˆŠè¨Šæ¯æ²’æœ‰ senderName/senderAvatarUrl
- æ–°è¨Šæ¯æœƒè‡ªå‹•å¡«å……

**é©—è­‰æ–¹æ³•**ï¼š
1. æŸ¥çœ‹èˆŠè¨Šæ¯ï¼šæ‡‰è©²é¡¯ç¤ºã€ŒæœªçŸ¥ç”¨æˆ¶ã€
2. ç™¼é€æ–°è¨Šæ¯ï¼šæ‡‰è©²é¡¯ç¤ºæ­£ç¢ºçš„ç”¨æˆ¶åå’Œé ­åƒ

**é æœŸçµæœ**ï¼š
- èˆŠè¨Šæ¯ï¼šé¡¯ç¤ºã€ŒæœªçŸ¥ç”¨æˆ¶ã€ï¼ˆæ­£å¸¸ï¼‰
- æ–°è¨Šæ¯ï¼šé¡¯ç¤ºæ­£ç¢ºçš„ç”¨æˆ¶åå’Œé ­åƒ

---

## ğŸ“Š æ€§èƒ½é©—è­‰

### Network æª¢æŸ¥æ¸…å–®

æ‰“é–‹ Networkï¼Œæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

- [ ] **messages API (cache hit)**: < 100ms
- [ ] **messages API (cache miss)**: < 300ms
- [ ] **é¦–å± FCP**: < 500ms
- [ ] **WebSocket é€£ç·š**: åªæœ‰ 1 æ¢
- [ ] **API è¼‰å…¥é †åº**: messages æœ€å…ˆï¼Œå…¶ä»–å»¶å¾Œ

### é©—è­‰æ­¥é©Ÿ

1. **æ¸…é™¤å¿«å–**ï¼š
   - æ‰“é–‹ DevTools â†’ Application â†’ Clear storage
   - æˆ–ä½¿ç”¨ç„¡ç—•æ¨¡å¼

2. **ç¬¬ä¸€æ¬¡è¼‰å…¥**ï¼ˆcache missï¼‰ï¼š
   - é€²å…¥èŠå¤©å®¤
   - æª¢æŸ¥ messages API æ™‚é–“ï¼ˆæ‡‰è©² < 300msï¼‰
   - æª¢æŸ¥ X-Cache headerï¼ˆæ‡‰è©²æ˜¯ MISSï¼‰

3. **ç¬¬äºŒæ¬¡è¼‰å…¥**ï¼ˆcache hitï¼‰ï¼š
   - é‡æ–°æ•´ç†é é¢
   - æª¢æŸ¥ messages API æ™‚é–“ï¼ˆæ‡‰è©² < 100msï¼‰
   - æª¢æŸ¥ X-Cache headerï¼ˆæ‡‰è©²æ˜¯ HITï¼‰

4. **Socket é€£ç·š**ï¼š
   - æª¢æŸ¥ Network â†’ WS
   - æ‡‰è©²åªæœ‰ 1 æ¢é€£ç·š
   - åˆ‡æ›æˆ¿é–“æ™‚ä¸é‡æ–°é€£æ¥

---

## ğŸš¨ å¦‚æœé‚„æ˜¯æœ‰å•é¡Œ

### Cache æ²’ Hit

**å¯èƒ½åŸå› **ï¼š
1. Redis æ²’é€£ä¸Š
2. Cache key ä¸ä¸€è‡´
3. TTL å¤ªçŸ­

**æª¢æŸ¥æ–¹æ³•**ï¼š
```bash
# æª¢æŸ¥ Redis é€£ç·š
redis-cli
> PING
# æ‡‰è©²è¿”å› PONG

# æª¢æŸ¥ cache key
> KEYS messages:*
```

### é‚„æ˜¯å¾ˆæ…¢

**å¯èƒ½åŸå› **ï¼š
1. DB æŸ¥è©¢é‚„æ˜¯ç”¨ JOIN
2. ç´¢å¼•æ²’å»ºç«‹
3. æŸ¥è©¢è¨ˆåŠƒä¸å°

**æª¢æŸ¥æ–¹æ³•**ï¼š
```sql
EXPLAIN ANALYZE
SELECT id, content, "senderName", "senderAvatarUrl", "createdAt"
FROM "ChatMessage"
WHERE "roomId" = 'your-room-id'
ORDER BY "createdAt" DESC
LIMIT 30;
```

---

**æ‰€æœ‰ä¿®å¾©å·²å®Œæˆï¼è«‹æŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿé©—è­‰ã€‚** âœ…

