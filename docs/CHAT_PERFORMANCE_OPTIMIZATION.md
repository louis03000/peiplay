# èŠå¤©ç³»çµ±æ•ˆèƒ½å„ªåŒ–å®Œæˆå ±å‘Š

## ğŸ“‹ å„ªåŒ–ç›®æ¨™

æ ¹æ“šæ•ˆèƒ½å•é¡Œåˆ†æï¼Œè§£æ±ºä»¥ä¸‹é—œéµå•é¡Œï¼š
1. GET /messages?limit=50 è¦ 7.75 ç§’ â†’ ç›®æ¨™ < 200ms
2. é€²èŠå¤©å®¤å¾ˆæ…¢ â†’ ç›®æ¨™ < 1 ç§’
3. ç™¼é€è¨Šæ¯å¾ˆæ…¢ â†’ ç›®æ¨™ < 300ms

## âœ… å·²å®Œæˆçš„å„ªåŒ–

### 1ï¸âƒ£ è³‡æ–™åº«å„ªåŒ–

#### âœ… ChatMessage ç´¢å¼•ç¢ºèª
- **ç´¢å¼•å·²å­˜åœ¨**ï¼š`(roomId, createdAt DESC)` - é€™æ˜¯èŠå¤©è¨Šæ¯æŸ¥è©¢çš„æ ¸å¿ƒç´¢å¼•
- **é¡å¤–ç´¢å¼•**ï¼š
  - `(senderId, createdAt DESC)` - ç”¨æ–¼æŸ¥è©¢ç”¨æˆ¶ç™¼é€çš„æ¶ˆæ¯
  - `(moderationStatus, createdAt DESC)` - ç”¨æ–¼å…§å®¹å¯©æŸ¥æŸ¥è©¢
- **SQL Migration æª”æ¡ˆ**ï¼š`prisma/migrations/ensure_chat_message_indexes.sql`

#### âœ… Cursor-based Pagination
- âœ… å·²å¯¦ç¾ï¼šä½¿ç”¨ `before` åƒæ•¸ï¼ˆcreatedAtï¼‰é€²è¡Œåˆ†é 
- âœ… ç¦æ­¢ä½¿ç”¨ OFFSETï¼ˆæœƒå°è‡´å…¨è¡¨æƒæï¼‰
- âœ… æŸ¥è©¢æ¢ä»¶ï¼š`WHERE roomId = ? AND created_at < lastMessageCursor`

### 2ï¸âƒ£ èŠå¤©ç´€éŒ„è¼‰å…¥å„ªåŒ–

#### âœ… GET /api/chat/rooms/[roomId]/messages
**å„ªåŒ–å‰å•é¡Œ**ï¼š
- é»˜èª limit=50ï¼ŒæŸ¥è©¢æ…¢
- æ²’æœ‰å……åˆ†åˆ©ç”¨ç´¢å¼•
- æ¬Šé™é©—è­‰é †åºåŸ·è¡Œ

**å„ªåŒ–å¾Œæ”¹é€²**ï¼š
```typescript
// âœ… æ¸›å°‘é»˜èªlimitåˆ°30
const limit = Math.min(parseInt(searchParams.get('limit') || '30'), 50);

// âœ… ä¸¦è¡Œé©—è­‰æ¬Šé™
const [membership, user] = await Promise.all([...]);

// âœ… ä½¿ç”¨ç´¢å¼•æŸ¥è©¢ï¼ˆroomId + createdAt DESCï¼‰
const where: any = {
  roomId, // å¿…é ˆå…ˆåŒ¹é…ç´¢å¼•çš„ç¬¬ä¸€å€‹æ¬„ä½
  moderationStatus: { not: 'REJECTED' },
};
```

**é æœŸæ•ˆèƒ½æå‡**ï¼š
- å¾ 7.75 ç§’ â†’ < 150msï¼ˆæ¸›å°‘ 98% æ™‚é–“ï¼‰

### 3ï¸âƒ£ ç™¼é€è¨Šæ¯ API å„ªåŒ–

#### âœ… POST /api/chat/rooms/[roomId]/messages
**å„ªåŒ–å‰å•é¡Œ**ï¼š
- åŒæ­¥æ›´æ–° lastMessageAtï¼Œé˜»å¡å›æ‡‰
- Promise.all ä¸­ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ

**å„ªåŒ–å¾Œæ”¹é€²**ï¼š
```typescript
// âœ… å…ˆå‰µå»ºè¨Šæ¯ï¼ˆå¿…é ˆåŒæ­¥ï¼‰
const message = await client.chatMessage.create({...});

// âœ… ç•°æ­¥æ›´æ–° lastMessageAtï¼ˆfire-and-forgetï¼‰
client.chatRoom.update({...}).catch(err => {
  console.error('Failed to update lastMessageAt:', err);
});
```

**é æœŸæ•ˆèƒ½æå‡**ï¼š
- å¾ 7 ç§’ â†’ < 200msï¼ˆæ¸›å°‘ 97% æ™‚é–“ï¼‰

#### âœ… Socket Server å„ªåŒ–
- åŒæ¨£å¯¦ç¾ç•°æ­¥æ›´æ–° lastMessageAt
- ä¸é˜»å¡æ¶ˆæ¯ç™¼é€æµç¨‹

### 4ï¸âƒ£ é€²èŠå¤©å®¤ API å„ªåŒ–

#### âœ… GET /api/chat/rooms
**å„ªåŒ–å‰å•é¡Œ**ï¼š
- è¤‡é›œçš„åµŒå¥— OR æ¢ä»¶æŸ¥è©¢
- æœªè®€æ¶ˆæ¯åœ¨æ‡‰ç”¨å±¤éæ¿¾ï¼ˆæŸ¥è©¢æ‰€æœ‰æ¶ˆæ¯ï¼‰
- æŸ¥è©¢å¤ªå¤šä¸å¿…è¦çš„åµŒå¥—è³‡æ–™

**å„ªåŒ–å¾Œæ”¹é€²**ï¼š
1. **ç°¡åŒ–æŸ¥è©¢çµæ§‹**ï¼š
   - å…ˆæŸ¥è©¢ memberships
   - ä¸¦è¡ŒæŸ¥è©¢å¿…è¦è³‡æ–™ï¼ˆmembers, lastMessages, bookingsï¼‰

2. **å„ªåŒ–æœªè®€æ¶ˆæ¯è¨ˆç®—**ï¼š
   ```typescript
   // âœ… ä½¿ç”¨è³‡æ–™åº« countï¼Œè€Œéæ‡‰ç”¨å±¤éæ¿¾
   const unreadCount = await client.chatMessage.count({
     where: {
       roomId: membership.roomId,
       senderId: { not: session.user.id },
       moderationStatus: { not: 'REJECTED' },
       createdAt: { gt: lastReadDate },
     },
   });
   ```

3. **æ¸›å°‘åµŒå¥—æŸ¥è©¢**ï¼š
   - ä½¿ç”¨ Map æ§‹å»ºæŸ¥æ‰¾è¡¨
   - åªåœ¨éœ€è¦æ™‚æŸ¥è©¢ booking/groupBooking

**é æœŸæ•ˆèƒ½æå‡**ï¼š
- å¾å¤šç§’ç´š â†’ < 500ms

### 5ï¸âƒ£ å‰ç«¯å„ªåŒ–

#### âœ… æ¸›å°‘åˆå§‹è¼‰å…¥è¨Šæ¯æ•¸é‡
- å¾ limit=50 â†’ limit=30
- æå‡é¦–æ¬¡è¼‰å…¥é€Ÿåº¦

### 6ï¸âƒ£ å¿«å–ç­–ç•¥

#### âœ… Redis Cacheï¼ˆèŠå¤©å®¤åˆ—è¡¨ï¼‰
```typescript
// âœ… 5ç§’TTLï¼Œç¢ºä¿å¯¦æ™‚æ€§
const cacheKey = `chat:rooms:${session.user.id}`;
await Cache.set(cacheKey, result, 5);
```

#### âœ… HTTP Cache Headers
- `Cache-Control: private, max-age=5, stale-while-revalidate=10`
- å€‹äººè³‡æ–™ä½¿ç”¨ private cache

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™å°æ¯”

| æ“ä½œ | å„ªåŒ–å‰ | å„ªåŒ–ç›®æ¨™ | é æœŸæ”¹å–„ |
|------|--------|----------|----------|
| é€²èŠå¤©å®¤ | > 3 ç§’ | < 1 ç§’ | 70%+ |
| messages API | 7.75 ç§’ | < 200ms | 98%+ |
| ç™¼é€è¨Šæ¯ | 7 ç§’ | < 300ms | 96%+ |

## ğŸ” é—œéµå„ªåŒ–é»ç¸½çµ

### 1. è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–
- âœ… ä½¿ç”¨æ­£ç¢ºçš„è¤‡åˆç´¢å¼•
- âœ… Cursor-based paginationï¼ˆé¿å… OFFSETï¼‰
- âœ… ä½¿ç”¨ count è€Œéæ‡‰ç”¨å±¤éæ¿¾
- âœ… ä¸¦è¡ŒæŸ¥è©¢æ¸›å°‘ç­‰å¾…æ™‚é–“

### 2. éåŒæ­¥è™•ç†
- âœ… lastMessageAt æ›´æ–°æ”¹ç‚ºç•°æ­¥ï¼ˆä¸é˜»å¡å›æ‡‰ï¼‰
- âœ… æ¸›å°‘åŒæ­¥ç­‰å¾…æ™‚é–“

### 3. æŸ¥è©¢ç°¡åŒ–
- âœ… æ¸›å°‘åµŒå¥—æŸ¥è©¢
- âœ… ä½¿ç”¨ select è€Œé includeï¼ˆåªé¸å¿…è¦æ¬„ä½ï¼‰
- âœ… æ¸›å°‘åˆå§‹è¼‰å…¥æ•¸æ“šé‡

### 4. å¿«å–ç­–ç•¥
- âœ… Redis cacheï¼ˆ5ç§’TTLï¼‰
- âœ… HTTP cache headers

## ğŸš€ å¾ŒçºŒå»ºè­°

1. **ç›£æ§æ•ˆèƒ½æŒ‡æ¨™**ï¼š
   - ä½¿ç”¨ APM å·¥å…·ç›£æ§ API å›æ‡‰æ™‚é–“
   - è¨­ç½®å‘Šè­¦ï¼ˆå¦‚æœ API > 300msï¼‰

2. **è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–**ï¼š
   - å®šæœŸæª¢æŸ¥æ…¢æŸ¥è©¢æ—¥èªŒ
   - è€ƒæ…®æ·»åŠ æ›´å¤šç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰

3. **å¿«å–ç­–ç•¥èª¿æ•´**ï¼š
   - æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´ TTL
   - è€ƒæ…®ä½¿ç”¨ Vercel Edge Cacheï¼ˆå¦‚æœé©ç”¨ï¼‰

4. **è² è¼‰æ¸¬è©¦**ï¼š
   - é€²è¡Œå£“åŠ›æ¸¬è©¦ï¼Œé©—è­‰å„ªåŒ–æ•ˆæœ
   - ç¢ºä¿é«˜ä½µç™¼å ´æ™¯ä¸‹æ•ˆèƒ½ç©©å®š

## ğŸ“ æª”æ¡ˆè®Šæ›´æ¸…å–®

1. âœ… `app/api/chat/rooms/[roomId]/messages/route.ts` - å„ªåŒ– GET/POST
2. âœ… `app/api/chat/rooms/route.ts` - å„ªåŒ– GETï¼Œæ·»åŠ å¿«å–
3. âœ… `socket-server/src/index.ts` - ç•°æ­¥æ›´æ–° lastMessageAt
4. âœ… `app/chat/[roomId]/page.tsx` - æ¸›å°‘åˆå§‹è¼‰å…¥ limit
5. âœ… `prisma/migrations/ensure_chat_message_indexes.sql` - ç¢ºä¿ç´¢å¼•å­˜åœ¨

## âœ… é©—è­‰æ–¹æ³•

åœ¨ç€è¦½å™¨ Network tab ä¸­æª¢æŸ¥ï¼š
- âœ… é€²èŠå¤©å®¤ï¼š< 1 ç§’
- âœ… messages APIï¼š< 200ms
- âœ… ç™¼é€è¨Šæ¯ï¼š< 300ms

å¦‚æœä»ç„¶å¾ˆæ…¢ï¼Œæª¢æŸ¥ï¼š
1. è³‡æ–™åº«ç´¢å¼•æ˜¯å¦æ­£ç¢ºå‰µå»º
2. æ˜¯å¦æœ‰å…¶ä»– N+1 æŸ¥è©¢å•é¡Œ
3. ç¶²è·¯å»¶é²æ˜¯å¦æ­£å¸¸

