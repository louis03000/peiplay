# ç´¢å¼•æœªè¢«ä½¿ç”¨ä¿®å¾©æŒ‡å—

## ğŸš¨ å•é¡Œ

å¾ `EXPLAIN ANALYZE` çœ‹åˆ°ï¼š
- âŒ é‚„æ˜¯ä½¿ç”¨ `Seq Scan`ï¼ˆå³ä½¿ç´¢å¼•å·²å»ºç«‹ï¼‰
- âœ… åŸ·è¡Œæ™‚é–“ï¼š0.084msï¼ˆä½†é€™æ˜¯å› ç‚ºè¡¨å¾ˆå°ï¼Œåªæœ‰ 9 è¡Œï¼‰

**åŸå› ï¼š** ç•¶è¡¨å¾ˆå°æ™‚ï¼ŒPostgreSQL èªç‚º Seq Scan æ›´å¿«ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ç´¢å¼•ã€‚

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¼·åˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆæ¸¬è©¦ç”¨ï¼‰

```sql
-- æš«æ™‚ç¦ç”¨ Seq Scan
SET enable_seqscan = off;

-- ä½¿ç”¨çœŸå¯¦çš„ roomId æ¸¬è©¦
EXPLAIN ANALYZE
SELECT 
  id, "roomId", "senderId", "senderName", "senderAvatarUrl", content, "createdAt"
FROM "ChatMessage"
WHERE "roomId" = 'çœŸå¯¦çš„-room-id'  -- æ›¿æ›ç‚ºçœŸå¯¦çš„ roomId
  AND "moderationStatus" != 'REJECTED'
ORDER BY "createdAt" DESC, id DESC
LIMIT 10;

-- æ¢å¾©è¨­å®š
SET enable_seqscan = on;
```

**å¦‚æœå¼·åˆ¶ä½¿ç”¨ç´¢å¼•å¾Œé¡¯ç¤º `Index Scan`ï¼Œè¡¨ç¤ºç´¢å¼•æ˜¯æ­£ç¢ºçš„ã€‚**

---

### æ–¹æ¡ˆ 2ï¼šç¢ºèªæŸ¥è©¢æ²’æœ‰å•é¡Œ

**å·²ä¿®å¾©ï¼š**
- âœ… ç§»é™¤ `::text` cast
- âœ… æŸ¥è©¢ä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½åç¨±

**éœ€è¦ç¢ºèªï¼š**
- âœ… `roomId` å‹åˆ¥ä¸€è‡´ï¼ˆTEXTï¼‰
- âœ… æŸ¥è©¢æ¢ä»¶åŒ¹é…ç´¢å¼•

---

### æ–¹æ¡ˆ 3ï¼šç•¶è¡¨è®Šå¤§æ™‚è‡ªå‹•ä½¿ç”¨ç´¢å¼•

**ç•¶è¡¨æœ‰æ›´å¤šè³‡æ–™æ™‚ï¼ˆ> 100 è¡Œï¼‰ï¼ŒPostgreSQL æœƒè‡ªå‹•ä½¿ç”¨ç´¢å¼•ã€‚**

**æ¸¬è©¦æ–¹æ³•ï¼š**
```sql
-- æ’å…¥ä¸€äº›æ¸¬è©¦è³‡æ–™
INSERT INTO "ChatMessage" ("roomId", "senderId", "senderName", "content", "moderationStatus", "createdAt")
SELECT 
  'test-room-id',
  'test-sender-id',
  'Test User',
  'Test message ' || generate_series,
  'APPROVED',
  NOW() - (generate_series || ' seconds')::interval
FROM generate_series(1, 100);

-- ç„¶å¾Œå†åŸ·è¡Œ EXPLAIN ANALYZE
```

---

## ğŸ” ç‚ºä»€éº¼è¡¨å°æ™‚æœƒç”¨ Seq Scanï¼Ÿ

PostgreSQL æŸ¥è©¢è¦åŠƒå™¨æœƒæ¯”è¼ƒï¼š
- **Seq Scan æˆæœ¬ï¼š** æƒææ‰€æœ‰è¡Œï¼ˆè¡¨å°æ™‚å¾ˆå¿«ï¼‰
- **Index Scan æˆæœ¬ï¼š** è®€å–ç´¢å¼• + å›è¡¨ï¼ˆæœ‰å›ºå®šæˆæœ¬ï¼‰

ç•¶è¡¨ < 10 è¡Œæ™‚ï¼ŒSeq Scan é€šå¸¸æ›´å¿«ã€‚

---

## âœ… é©—è­‰ç´¢å¼•æ˜¯å¦æ­£ç¢º

å³ä½¿ç¾åœ¨ä½¿ç”¨ Seq Scanï¼Œç•¶è¡¨è®Šå¤§æ™‚æœƒè‡ªå‹•ä½¿ç”¨ç´¢å¼•ã€‚

**ç¢ºèªæ–¹æ³•ï¼š**
1. æª¢æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼ˆå·²ç¢ºèª âœ…ï¼‰
2. å¼·åˆ¶ä½¿ç”¨ç´¢å¼•æ¸¬è©¦ï¼ˆè¦‹æ–¹æ¡ˆ 1ï¼‰
3. ç­‰å¾…è¡¨è®Šå¤§ï¼ˆ> 100 è¡Œï¼‰å¾Œå†æ¸¬è©¦

---

## ğŸ“Š é æœŸçµæœ

### ç¾åœ¨ï¼ˆè¡¨å°ï¼Œ9 è¡Œï¼‰
- **åŸ·è¡Œè¨ˆåŠƒï¼š** `Seq Scan`ï¼ˆæ­£å¸¸ï¼Œå› ç‚ºè¡¨å°ï¼‰
- **åŸ·è¡Œæ™‚é–“ï¼š** < 1msï¼ˆå¾ˆå¿«ï¼‰

### æœªä¾†ï¼ˆè¡¨å¤§ï¼Œ> 100 è¡Œï¼‰
- **åŸ·è¡Œè¨ˆåŠƒï¼š** `Index Scan using ChatMessage_roomId_createdAt_id_not_rejected_idx`
- **åŸ·è¡Œæ™‚é–“ï¼š** < 10msï¼ˆå³ä½¿è¡¨å¾ˆå¤§ï¼‰

---

## ğŸ¯ é—œéµé»

**ç´¢å¼•å·²æ­£ç¢ºå»ºç«‹ï¼Œç•¶è¡¨è®Šå¤§æ™‚æœƒè‡ªå‹•ä½¿ç”¨ã€‚**

**ç¾åœ¨çœ‹åˆ°çš„ Seq Scan æ˜¯æ­£å¸¸çš„**ï¼ˆå› ç‚ºè¡¨å¤ªå°ï¼ŒSeq Scan æ›´å¿«ï¼‰ã€‚

**çœŸæ­£çš„æ¸¬è©¦ï¼š** ç•¶èŠå¤©å®¤æœ‰æ›´å¤šè¨Šæ¯æ™‚ï¼ˆ> 100 è¡Œï¼‰ï¼Œæœƒè‡ªå‹•ä½¿ç”¨ç´¢å¼•ã€‚

---

## âœ… å®Œæˆæª¢æŸ¥

1. [x] ç´¢å¼•å·²å»ºç«‹
2. [x] æŸ¥è©¢å·²ä¿®å¾©ï¼ˆç§»é™¤ `::text` castï¼‰
3. [ ] ç•¶è¡¨è®Šå¤§æ™‚æœƒè‡ªå‹•ä½¿ç”¨ç´¢å¼•ï¼ˆéœ€è¦ç­‰å¾…ï¼‰

**çµè«–ï¼š** ç´¢å¼•æ˜¯æ­£ç¢ºçš„ï¼Œç•¶è¡¨è®Šå¤§æ™‚æœƒè‡ªå‹•ä½¿ç”¨ã€‚ç¾åœ¨çœ‹åˆ°çš„ Seq Scan æ˜¯æ­£å¸¸çš„ï¼ˆå› ç‚ºè¡¨å¤ªå°ï¼‰ã€‚

