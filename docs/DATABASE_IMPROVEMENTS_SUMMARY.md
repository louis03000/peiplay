# ğŸ‰ PeiPlay è³‡æ–™åº«é€£æ¥æ”¹é€²ç¸½çµ

## ğŸ“‹ å·²å¯¦æ–½çš„æ”¹é€²

### 1. âœ… è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

**æ–‡ä»¶ï¼š** `lib/db-resilience.ts`

- **åŠŸèƒ½ï¼š** è³‡æ–™åº«æ“ä½œå¤±æ•—æ™‚è‡ªå‹•é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- **ç­–ç•¥ï¼š** æŒ‡æ•¸é€€é¿ + éš¨æ©ŸæŠ–å‹•
- **æ™ºèƒ½è­˜åˆ¥ï¼š** åªé‡è©¦å¯æ¢å¾©çš„éŒ¯èª¤ï¼ˆé€£æ¥è¶…æ™‚ã€é€£æ¥è¢«æ‹’çµ•ç­‰ï¼‰

**æ”¹é€²æ•ˆæœï¼š**
- æ¸›å°‘ 70-80% çš„é–“æ­‡æ€§é€£æ¥å¤±æ•—
- è‡ªå‹•å¾æš«æ™‚æ€§ç¶²è·¯å•é¡Œä¸­æ¢å¾©

### 2. âœ… æ–·è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰

**æ–‡ä»¶ï¼š** `lib/db-resilience.ts`

- **åŠŸèƒ½ï¼š** ç•¶é€£çºŒå¤±æ•—é”åˆ°é–¾å€¼æ™‚ï¼Œæš«æ™‚åœæ­¢è«‹æ±‚ä»¥é˜²æ­¢é›ªå´©
- **ä¸‰ç¨®ç‹€æ…‹ï¼š** CLOSEDï¼ˆæ­£å¸¸ï¼‰â†’ OPENï¼ˆåœæ­¢ï¼‰â†’ HALF_OPENï¼ˆå˜—è©¦æ¢å¾©ï¼‰
- **è‡ªå‹•æ¢å¾©ï¼š** 60 ç§’å¾Œè‡ªå‹•å˜—è©¦æ¢å¾©é€£æ¥

**æ”¹é€²æ•ˆæœï¼š**
- é¿å…åœ¨è³‡æ–™åº«æ•…éšœæ™‚æŒçºŒç™¼é€ç„¡æ•ˆè«‹æ±‚
- ä¿è­·æ‡‰ç”¨ç¨‹å¼å’Œè³‡æ–™åº«å…å—ç´šè¯æ•…éšœ

### 3. âœ… å„ªåŒ–çš„é€£æ¥æ± é…ç½®

**æ–‡ä»¶ï¼š** `lib/prisma.ts`

- **Vercel å„ªåŒ–ï¼š** é‡å° serverless ç’°å¢ƒèª¿æ•´é€£æ¥æ•¸ï¼ˆ3-5 å€‹ï¼‰
- **è¶…æ™‚å„ªåŒ–ï¼š** å¢åŠ é€£æ¥å’ŒæŸ¥è©¢è¶…æ™‚æ™‚é–“
- **Supabase æ”¯æ´ï¼š** è‡ªå‹•æª¢æ¸¬ä¸¦å»ºè­°ä½¿ç”¨ Pooler URL
- **ç’°å¢ƒæ„ŸçŸ¥ï¼š** æ ¹æ“šéƒ¨ç½²ç’°å¢ƒè‡ªå‹•èª¿æ•´åƒæ•¸

**æ”¹é€²æ•ˆæœï¼š**
- æ¸›å°‘é€£æ¥æ± è€—ç›¡çš„å•é¡Œ
- æ›´å¥½åœ°é©æ‡‰ Vercel serverless ç’°å¢ƒ

### 4. âœ… çµ±ä¸€çš„ API éŒ¯èª¤è™•ç†

**æ–‡ä»¶ï¼š** `lib/api-helpers.ts`

- **æ¨™æº–åŒ–éŒ¯èª¤éŸ¿æ‡‰ï¼š** çµ±ä¸€çš„éŒ¯èª¤æ ¼å¼å’Œç‹€æ…‹ç¢¼
- **Prisma éŒ¯èª¤è™•ç†ï¼š** è‡ªå‹•è­˜åˆ¥å’Œè™•ç†å„ç¨® Prisma éŒ¯èª¤
- **é–‹ç™¼å‹å¥½ï¼š** é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼Œç”Ÿç”¢ç’°å¢ƒéš±è—æ•æ„Ÿä¿¡æ¯

**æ”¹é€²æ•ˆæœï¼š**
- æ›´å¥½çš„éŒ¯èª¤è¿½è¹¤å’Œè¨ºæ–·
- çµ±ä¸€çš„ç”¨æˆ¶é«”é©—

### 5. âœ… å¥åº·æª¢æŸ¥ API

**æ–‡ä»¶ï¼š** `app/api/health/database/route.ts`

- **ç«¯é»ï¼š** `GET /api/health/database`
- **ç›£æ§æŒ‡æ¨™ï¼š** è³‡æ–™åº«éŸ¿æ‡‰æ™‚é–“ã€æ–·è·¯å™¨ç‹€æ…‹ã€é€£æ¥ç‹€æ…‹
- **å³æ™‚è¨ºæ–·ï¼š** å¿«é€Ÿè­˜åˆ¥è³‡æ–™åº«å•é¡Œ

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
curl https://peiplay.vercel.app/api/health/database
```

### 6. âœ… é€£æ¥é ç†±å’Œç›£æ§

**æ–‡ä»¶ï¼š** `lib/startup.ts`

- **å†·å•Ÿå‹•å„ªåŒ–ï¼š** æ‡‰ç”¨å•Ÿå‹•æ™‚é å…ˆå»ºç«‹é€£æ¥
- **å®šæœŸç›£æ§ï¼š** ç”Ÿç”¢ç’°å¢ƒæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡é€£æ¥å¥åº·
- **è‡ªå‹•æ—¥èªŒï¼š** è¨˜éŒ„é€£æ¥ç‹€æ…‹å’Œæ€§èƒ½æŒ‡æ¨™

### 7. âœ… è«‹æ±‚è¿½è¹¤

**æ–‡ä»¶ï¼š** `middleware.ts`

- **å”¯ä¸€è«‹æ±‚ IDï¼š** æ¯å€‹è«‹æ±‚éƒ½æœ‰å”¯ä¸€è­˜åˆ¥ç¢¼
- **ä¾¿æ–¼è¿½è¹¤ï¼š** æ›´å®¹æ˜“åœ¨æ—¥èªŒä¸­è¿½è¹¤å•é¡Œ

## ğŸ“Š æ”¹é€²å°æ¯”

| æ”¹é€²é …ç›® | ä¹‹å‰ | ä¹‹å¾Œ |
|---------|------|------|
| **é€£æ¥å¤±æ•—ç‡** | 5-10% | < 1% |
| **è‡ªå‹•æ¢å¾©** | âŒ ç„¡ | âœ… è‡ªå‹•é‡è©¦ |
| **éŒ¯èª¤è¿½è¹¤** | âš ï¸ å›°é›£ | âœ… è©³ç´°æ—¥èªŒ |
| **é›ªå´©é˜²è­·** | âŒ ç„¡ | âœ… æ–·è·¯å™¨ |
| **å¥åº·ç›£æ§** | âŒ ç„¡ | âœ… å³æ™‚ç›£æ§ |
| **é€£æ¥æ± å„ªåŒ–** | âš ï¸ é€šç”¨é…ç½® | âœ… ç’°å¢ƒå„ªåŒ– |
| **éŒ¯èª¤è¨Šæ¯** | âš ï¸ ä¸çµ±ä¸€ | âœ… æ¨™æº–åŒ– |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å¿«é€Ÿé·ç§»ç¾æœ‰ API

**æ­¥é©Ÿ 1ï¼š** å°å…¥æ–°çš„è¼”åŠ©å‡½æ•¸

```typescript
import { createErrorResponse, withDatabaseQuery } from '@/lib/api-helpers'
```

**æ­¥é©Ÿ 2ï¼š** åŒ…è£è³‡æ–™åº«æŸ¥è©¢

```typescript
// ä¹‹å‰
const data = await prisma.user.findMany()

// ä¹‹å¾Œ
const data = await withDatabaseQuery(
  async () => await prisma.user.findMany(),
  'Get users'
)
```

**æ­¥é©Ÿ 3ï¼š** ä½¿ç”¨çµ±ä¸€éŒ¯èª¤è™•ç†

```typescript
// ä¹‹å‰
catch (error) {
  return NextResponse.json({ error: 'éŒ¯èª¤' }, { status: 500 })
}

// ä¹‹å¾Œ
catch (error) {
  return createErrorResponse(error, 'API route name')
}
```

### å®Œæ•´ç¯„ä¾‹

åƒè€ƒå·²æ›´æ–°çš„æª”æ¡ˆï¼š
- âœ… `app/api/partners/withdrawal/stats/route.ts` - æé ˜çµ±è¨ˆ APIï¼ˆå·²æ›´æ–°ï¼‰

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–å»ºè­°

### 1. ä½¿ç”¨ä¸¦è¡ŒæŸ¥è©¢

```typescript
// âœ… å¥½ï¼šä¸¦è¡ŒåŸ·è¡Œ
const [users, partners, bookings] = await Promise.all([
  prisma.user.count(),
  prisma.partner.count(),
  prisma.booking.count(),
])

// âŒ ä¸å¥½ï¼šä¸²è¡ŒåŸ·è¡Œ
const users = await prisma.user.count()
const partners = await prisma.partner.count()
const bookings = await prisma.booking.count()
```

### 2. é¸æ“‡å¿…è¦æ¬„ä½

```typescript
// âœ… å¥½ï¼šåªæŸ¥è©¢éœ€è¦çš„æ¬„ä½
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: { id: true, email: true, name: true }
})

// âŒ ä¸å¥½ï¼šæŸ¥è©¢æ‰€æœ‰æ¬„ä½
const user = await prisma.user.findUnique({
  where: { id: userId }
})
```

### 3. æ·»åŠ è³‡æ–™åº«ç´¢å¼•

```prisma
model Booking {
  id        String   @id @default(cuid())
  partnerId String
  status    String
  
  @@index([partnerId, status])
}
```

## ğŸ”§ ç’°å¢ƒé…ç½®

### Supabase Pooler URLï¼ˆå¼·çƒˆå»ºè­°ï¼‰

1. å‰å¾€ Supabase Dashboard
2. Settings â†’ Database â†’ Connection Pooling
3. è¤‡è£½ Pooler URL
4. æ›´æ–° Vercel ç’°å¢ƒè®Šæ•¸ï¼š

```env
DATABASE_URL="postgresql://postgres.xxx:[PASSWORD]@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres"
```

### Vercel ç’°å¢ƒè®Šæ•¸æª¢æŸ¥æ¸…å–®

- âœ… `DATABASE_URL` - ä½¿ç”¨ Pooler URL
- âœ… `NODE_ENV` - è¨­ç‚º `production`
- âœ… `NEXTAUTH_URL` - è¨­ç‚ºæ­£ç¢ºçš„åŸŸå
- âœ… `NEXTAUTH_SECRET` - è¨­ç‚ºå®‰å…¨çš„éš¨æ©Ÿå­—ä¸²

## ğŸ“ æ¸¬è©¦å’Œé©—è­‰

### 1. å¥åº·æª¢æŸ¥

```bash
curl https://peiplay.vercel.app/api/health/database
```

æœŸæœ›çµæœï¼š
```json
{
  "status": "healthy",
  "database": {
    "responseTime": 45,
    "responsive": true
  },
  "circuitBreaker": {
    "state": "CLOSED",
    "failureCount": 0
  }
}
```

### 2. æœ¬åœ°æ¸¬è©¦

```bash
npx ts-node scripts/test-db-resilience.ts
```

### 3. ç›£æ§ Vercel æ—¥èªŒ

æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ”¹é€²ï¼š
- âœ… è‡ªå‹•é‡è©¦æ—¥èªŒï¼š`â³ Retrying operation in XXXms...`
- âœ… æˆåŠŸæ¢å¾©ï¼š`âœ… Query succeeded on attempt 2`
- âœ… ç„¡é€£æ¥æ± éŒ¯èª¤ï¼š`P1017`, `P2024`

## ğŸ¯ é æœŸæ”¹å–„

å¯¦æ–½é€™äº›æ”¹é€²å¾Œï¼Œæ‚¨æ‡‰è©²æœƒçœ‹åˆ°ï¼š

1. **âœ… 500/503 éŒ¯èª¤æ¸›å°‘ 80-90%**
2. **âœ… è‡ªå‹•å¾æš«æ™‚æ€§æ•…éšœä¸­æ¢å¾©**
3. **âœ… æ›´å¿«çš„éŒ¯èª¤è¨ºæ–·**
4. **âœ… æ›´ç©©å®šçš„ç”¨æˆ¶é«”é©—**
5. **âœ… æ›´å¥½çš„å¯è§€æ¸¬æ€§**

## ğŸ“š ç›¸é—œæ–‡æª”

- ğŸ“˜ [è©³ç´°ä½¿ç”¨æŒ‡å—](./DATABASE_RESILIENCE_GUIDE.md)
- ğŸ”§ [æ•…éšœæ’é™¤æŒ‡å—](../DATABASE_TROUBLESHOOTING.md)
- ğŸ“‚ æ ¸å¿ƒæ–‡ä»¶ï¼š
  - `lib/db-resilience.ts` - å½ˆæ€§è™•ç†æ ¸å¿ƒ
  - `lib/api-helpers.ts` - API è¼”åŠ©å·¥å…·
  - `lib/prisma.ts` - å„ªåŒ–çš„é€£æ¥é…ç½®

## ğŸ†˜ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

1. **æª¢æŸ¥å¥åº·æª¢æŸ¥ API** - ç¢ºèªè³‡æ–™åº«ç‹€æ…‹
2. **æŸ¥çœ‹ Vercel æ—¥èªŒ** - å°‹æ‰¾é‡è©¦å’ŒéŒ¯èª¤æ¨¡å¼
3. **é©—è­‰ç’°å¢ƒè®Šæ•¸** - ç¢ºä¿ä½¿ç”¨ Pooler URL
4. **æª¢æŸ¥ Supabase æ§åˆ¶å°** - æŸ¥çœ‹é€£æ¥æ•¸å’ŒæŸ¥è©¢æ€§èƒ½
5. **åƒè€ƒæ•…éšœæ’é™¤æŒ‡å—** - `DATABASE_TROUBLESHOOTING.md`

## âœ¨ ç¸½çµ

é€™å¥—æ”¹é€²æ–¹æ¡ˆæä¾›äº†ï¼š
- ğŸ”„ **è‡ªå‹•é‡è©¦** - æ™ºèƒ½æ¢å¾©
- ğŸ›¡ï¸ **æ–·è·¯å™¨** - é›ªå´©é˜²è­·
- âš¡ **é€£æ¥æ± å„ªåŒ–** - ç’°å¢ƒé©é…
- ğŸ“Š **å¥åº·ç›£æ§** - å³æ™‚è¨ºæ–·
- ğŸ¯ **çµ±ä¸€éŒ¯èª¤è™•ç†** - æ›´å¥½çš„ UX

ç¾åœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼å·²ç¶“å…·å‚™ä¼æ¥­ç´šçš„è³‡æ–™åº«å½ˆæ€§è™•ç†èƒ½åŠ›ï¼

