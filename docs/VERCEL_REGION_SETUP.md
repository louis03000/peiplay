# Vercel åœ°å€è¨­å®šæŒ‡å—

> ğŸ“Œ **æ›´æ–°æ™‚é–“**: 2025-12-17  
> âœ… **å·²ç¢ºèª**: Upstash Redis å’Œ Vercel Functions éƒ½å·²è¨­å®šç‚º Singapore (sin1)

## ğŸ¯ ç‚ºä»€éº¼è¦è¨­å®šåœ°å€ï¼Ÿ

å¦‚æœæ‚¨çš„ Vercel functions å’Œ Upstash Redis åœ¨ä¸åŒåœ°å€ï¼Œæœƒæœ‰è·¨å€åŸŸå»¶é²ï¼š
- **ç›®å‰ç‹€æ³**ï¼šVercel å¯èƒ½åœ¨ `iad1` (ç¾æ±)ï¼ŒUpstash å¯èƒ½åœ¨æ–°åŠ å¡
- **å»¶é²å½±éŸ¿**ï¼šæ¯æ¬¡ Redis è«‹æ±‚å¯èƒ½å¤š 200-400ms
- **ç›®æ¨™**ï¼šå°‡ Vercel å’Œ Upstash è¨­å®šåœ¨åŒä¸€åœ°å€ï¼ˆä¾‹å¦‚ï¼šéƒ½é¸ `hkg1` æˆ– `sin1`ï¼‰

---

## æ–¹æ³• 1ï¼šVercel Dashboard è¨­å®šï¼ˆæ¨è–¦ï¼‰

### æ­¥é©Ÿ 1ï¼šç™»å…¥ Vercel Dashboard

1. å‰å¾€ [Vercel Dashboard](https://vercel.com/dashboard)
2. æ‰¾åˆ°æ‚¨çš„ `peiplay` å°ˆæ¡ˆ
3. é»æ“Šé€²å…¥å°ˆæ¡ˆ

### æ­¥é©Ÿ 2ï¼šé€²å…¥ Settings

1. é»æ“Šé ‚éƒ¨é¸å–®çš„ **Settings** æ¨™ç±¤
2. åœ¨å·¦å´é¸å–®ä¸­æ‰¾åˆ° **Functions**ï¼ˆæˆ– **Serverless Functions**ï¼‰

### æ­¥é©Ÿ 3ï¼šè¨­å®š Deployment Region

1. æ‰¾åˆ° **Deployment Region** æˆ– **Region** é¸é …
2. å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡åœ°å€ï¼š
   - **`hkg1`** - é¦™æ¸¯ï¼ˆæ¨è–¦ï¼Œæ¥è¿‘å°ç£ï¼‰
   - **`sin1`** - æ–°åŠ å¡
   - **`sfo1`** - èˆŠé‡‘å±±
   - **`iad1`** - è¯ç››é “ç‰¹å€ï¼ˆç¾æ±ï¼‰

3. **å»ºè­°é¸æ“‡**ï¼š
   - å¦‚æœ Upstash Redis åœ¨ **Tokyo/Singapore** â†’ é¸ `hkg1` æˆ– `sin1`
   - å¦‚æœ Upstash Redis åœ¨ **US-East** â†’ é¸ `iad1`

4. é»æ“Š **Save**

### æ­¥é©Ÿ 4ï¼šé‡æ–°éƒ¨ç½²

è¨­å®šå¾Œéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆï¼š

1. é»æ“Š **Deployments** æ¨™ç±¤
2. æ‰¾åˆ°æœ€æ–°çš„éƒ¨ç½²
3. é»æ“Šå³å´çš„ **...** é¸å–®
4. é¸æ“‡ **Redeploy** â†’ **Use Existing Build**ï¼ˆå¿«é€Ÿé‡æ–°éƒ¨ç½²ï¼‰

---

## æ–¹æ³• 2ï¼šåœ¨ vercel.json ä¸­è¨­å®šï¼ˆç¨‹å¼ç¢¼ç´šåˆ¥ï¼‰

### è¨­å®š vercel.json

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„çš„ `vercel.json` ä¸­æ·»åŠ ï¼š

```json
{
  "functions": {
    "app/api/**/*.ts": {
      "regions": ["hkg1"]
    }
  }
}
```

### å¯ç”¨çš„åœ°å€ä»£ç¢¼

```json
{
  "functions": {
    "app/api/**/*.ts": {
      "regions": [
        "hkg1",    // é¦™æ¸¯ï¼ˆæ¨è–¦ï¼Œæ¥è¿‘å°ç£ï¼‰
        "sin1",    // æ–°åŠ å¡
        "sfo1",    // èˆŠé‡‘å±±
        "iad1",    // è¯ç››é “ç‰¹å€ï¼ˆç¾æ±ï¼‰
        "syd1",    // é›ªæ¢¨
        "fra1",    // æ³•è˜­å…‹ç¦
        "cle1"     // å…‹é‡Œå¤«è˜­
      ]
    }
  }
}
```

### é™åˆ¶ç‰¹å®š API è·¯ç”±çš„åœ°å€

å¦‚æœåªæƒ³è¨­å®šç‰¹å®š API è·¯ç”±ï¼ˆä¾‹å¦‚èŠå¤©ç›¸é—œçš„ APIï¼‰ï¼š

```json
{
  "functions": {
    "app/api/chat/**/*.ts": {
      "regions": ["hkg1"]
    },
    "app/api/chatrooms/**/*.ts": {
      "regions": ["hkg1"]
    }
  }
}
```

---

## æ–¹æ³• 3ï¼šåœ¨ API Route ä¸­è¨­å®šï¼ˆåƒ…é™ Edge Runtimeï¼‰

âš ï¸ **æ³¨æ„**ï¼šé€™å€‹æ–¹æ³•**ä¸é©ç”¨**æ–¼æ‚¨çš„èŠå¤© APIï¼Œå› ç‚ºï¼š
- éœ€è¦ä½¿ç”¨ Prismaï¼ˆéœ€è¦ Node.js runtimeï¼‰
- éœ€è¦ä½¿ç”¨ next-auth sessionï¼ˆéœ€è¦ Node.js runtimeï¼‰
- Edge Runtime ä¸æ”¯æ´é€™äº›åŠŸèƒ½

ä½†å¦‚æœæœªä¾†æœ‰å…¶ä»–ç°¡å–®çš„ API æƒ³è¦ä½¿ç”¨ Edge Runtimeï¼Œå¯ä»¥é€™æ¨£è¨­å®šï¼š

```typescript
export const runtime = 'edge';
export const regions = ['hkg1', 'sin1'];
```

---

## ğŸ¯ æ¨è–¦è¨­å®šï¼ˆæ ¹æ“šæ‚¨çš„ Upstash Redis åœ°å€ï¼‰

### å¦‚æœ Upstash Redis åœ¨ Tokyo/Singapore

**Vercel Dashboard è¨­å®š**ï¼š
- Region: **`hkg1`** (é¦™æ¸¯) æˆ– **`sin1`** (æ–°åŠ å¡)

**æˆ– vercel.json**ï¼š
```json
{
  "functions": {
    "app/api/**/*.ts": {
      "regions": ["hkg1"]
    }
  }
}
```

### å¦‚æœ Upstash Redis åœ¨ US-East

**Vercel Dashboard è¨­å®š**ï¼š
- Region: **`iad1`** (è¯ç››é “ç‰¹å€)

**æˆ– vercel.json**ï¼š
```json
{
  "functions": {
    "app/api/**/*.ts": {
      "regions": ["iad1"]
    }
  }
}
```

---

## âœ… å¦‚ä½•é©—è­‰åœ°å€è¨­å®šç”Ÿæ•ˆï¼Ÿ

### æ–¹æ³• 1ï¼šæª¢æŸ¥ Response Header

éƒ¨ç½²å¾Œï¼Œæª¢æŸ¥ API å›æ‡‰çš„ Headerï¼š

```bash
curl -I https://peiplay.vercel.app/api/chat/rooms/xxx/messages
```

æŸ¥çœ‹ `x-vercel-id` headerï¼š
- `hkg1::xxx` â†’ é‹è¡Œåœ¨é¦™æ¸¯
- `iad1::xxx` â†’ é‹è¡Œåœ¨ç¾æ±
- `sin1::xxx` â†’ é‹è¡Œåœ¨æ–°åŠ å¡

### æ–¹æ³• 2ï¼šæª¢æŸ¥ Vercel Logs

1. åœ¨ Vercel Dashboard â†’ Deployments
2. é»æ“Šæœ€æ–°çš„éƒ¨ç½²
3. æŸ¥çœ‹ **Functions** é ç±¤
4. æ¯å€‹ function æœƒé¡¯ç¤ºé‹è¡Œçš„åœ°å€

---

## ğŸ” å¦‚ä½•ç¢ºèª Upstash Redis çš„åœ°å€ï¼Ÿ

1. ç™»å…¥ [Upstash Console](https://console.upstash.com/)
2. é¸æ“‡æ‚¨çš„ Redis database
3. æŸ¥çœ‹ **Region** æ¬„ä½
4. å¸¸è¦‹åœ°å€ï¼š
   - **Tokyo** (æ—¥æœ¬) â†’ é¸ `hkg1` æˆ– `sin1`
   - **Singapore** (æ–°åŠ å¡) â†’ é¸ `sin1` æˆ– `hkg1`
   - **US-East** (ç¾åœ‹æ±éƒ¨) â†’ é¸ `iad1`

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **å„ªå…ˆä½¿ç”¨ Vercel Dashboard è¨­å®š**ï¼ˆæ–¹æ³• 1ï¼‰
   - æœ€ç°¡å–®
   - ä¸éœ€è¦æ”¹ä»£ç¢¼
   - å¯ä»¥éš¨æ™‚èª¿æ•´

2. **å¦‚æœè¦åœ¨ä»£ç¢¼ä¸­æ§åˆ¶**ï¼Œä½¿ç”¨ `vercel.json`ï¼ˆæ–¹æ³• 2ï¼‰
   - å¯ä»¥é‡å°ä¸åŒ API è¨­å®šä¸åŒåœ°å€
   - ç‰ˆæœ¬æ§åˆ¶å‹å¥½

3. **é¿å…ä½¿ç”¨ Edge Runtime**ï¼ˆæ–¹æ³• 3ï¼‰
   - é™¤é API ä¸éœ€è¦è³‡æ–™åº«æˆ–è¤‡é›œçš„ Node.js åŠŸèƒ½

---

## ğŸš¨ æ³¨æ„äº‹é …

1. **é‡æ–°éƒ¨ç½²å¾Œæ‰æœƒç”Ÿæ•ˆ**
   - è¨­å®šå¾Œå¿…é ˆé‡æ–°éƒ¨ç½²
   - ç¾æœ‰çš„éƒ¨ç½²ä¸æœƒæ”¹è®Šåœ°å€

2. **åœ°å€è¨­å®šå½±éŸ¿æ‰€æœ‰ Functions**
   - Dashboard è¨­å®šæ˜¯é …ç›®ç´šåˆ¥
   - `vercel.json` å¯ä»¥é‡å°ç‰¹å®šè·¯ç”±

3. **æˆæœ¬è€ƒé‡**
   - ä¸åŒåœ°å€å¯èƒ½æœ‰ä¸åŒçš„å®šåƒ¹
   - é€šå¸¸å·®ç•°ä¸å¤§

4. **Cold Start**
   - é¸æ“‡é›¢ä½¿ç”¨è€…è¿‘çš„åœ°å€å¯ä»¥æ¸›å°‘ Cold Start æ™‚é–“
   - ä½†å¦‚æœè³‡æ–™åº«åœ¨å¦ä¸€åœ°å€ï¼Œæ•´é«”å¯èƒ½æ›´æ…¢

