generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String                 @id @default(cuid())
  email                         String                 @unique
  password                      String
  name                          String?
  birthday                      DateTime?
  phone                         String?
  role                          UserRole               @default(CUSTOMER)
  createdAt                     DateTime               @default(now())
  updatedAt                     DateTime               @updatedAt
  isTwoFactorEnabled            Boolean                @default(false)
  lockUntil                     DateTime?
  loginAttempts                 Int                    @default(0)
  twoFactorSecret               String?
  discord                       String?
  isSuspended                   Boolean                @default(false)
  suspensionEndsAt              DateTime?
  suspensionReason              String?
  emailVerified                 Boolean                @default(false)
  emailVerificationCode         String?
  emailVerificationExpires      DateTime?
  emailNotifications            Boolean                @default(true)
  messageNotifications          Boolean                @default(true)
  bookingNotifications          Boolean                @default(true)
  twoFactorEnabled              Boolean                @default(false)
  loginAlerts                   Boolean                @default(true)
  securityAlerts                Boolean                @default(true)
  customer                      Customer?
  partner                       Partner?
  reviewsReceived               Review[]               @relation("Reviewee")
  reviewsGiven                  Review[]               @relation("Reviewer")
  securityLogs                  SecurityLog[]
  messagesSent                  Message[]              @relation("MessageSender")
  messagesReceived              Message[]              @relation("MessageReceiver")
  chatMessagesSent              ChatMessage[]          @relation("ChatMessageSender")
  chatRoomMembers               ChatRoomMember[]
  messageReadReceipts           MessageReadReceipt[]
  notifications                 Notification[]
  announcements                 Announcement[]         @relation("AnnouncementCreator")
  personalNotificationsReceived PersonalNotification[] @relation("PersonalNotificationReceiver")
  personalNotificationsSent     PersonalNotification[] @relation("PersonalNotificationSender")
  adminMessagesReceived         AdminMessage[]         @relation("AdminMessageReceiver")
  adminMessagesSent             AdminMessage[]         @relation("AdminMessageSender")

  @@index([isSuspended, suspensionEndsAt])
  @@index([role])
}

model Partner {
  id                      String                    @id @default(cuid())
  name                    String
  birthday                DateTime
  phone                   String
  coverImage              String
  games                   String[]
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  isAvailableNow          Boolean                   @default(false)
  availableNowSince       DateTime?
  userId                  String                    @unique
  status                  PartnerStatus             @default(PENDING)
  isRankBooster           Boolean                   @default(false)
  rankBoosterNote         String?
  rankBoosterRank         String?
  rankBoosterImages       String[]                  @default([])
  customerMessage         String?
  halfHourlyRate          Float
  chatHourlyRate          Float?
  images                  String[]                  @default([])
  inviteCode              String?
  invitedBy               String?
  bankAccountNumber       String?
  bankCode                String?
  contractFile            String?
  referralEarnings        Float                     @default(0)
  referralCount           Int                       @default(0)
  totalReferralEarnings   Float                     @default(0)
  referralPlatformFee     Float                     @default(10.00)
  referralBonusPercentage Float                     @default(5.00)
  noResponseCount         Int                       @default(0)
  lastNoResponseReset     DateTime?
  allowGroupBooking       Boolean                   @default(false)
  // 新增欄位
  interests               String[]                  @default([]) // 興趣
  gender                  String? // 性別
  idVerificationPhoto     String? // 身分證自拍
  idVerificationStatus    IdVerificationStatus      @default(PENDING) // 身分驗證狀態
  supportsChatOnly        Boolean                   @default(false) // 是否支援純聊天
  chatOnlyRate            Float? // 純聊天收費
  FavoritePartner         FavoritePartner[]
  GroupBookingParticipant GroupBookingParticipant[]
  user                    User                      @relation(fields: [userId], references: [id])
  referralsReceived       ReferralRecord?           @relation("Invitee")
  referralsGiven          ReferralRecord[]          @relation("Inviter")
  schedules               Schedule[]
  withdrawalRequests      WithdrawalRequest[]
  promoCodes              PromoCode[]
  rankingHistories        RankingHistory[]

  @@index([status])
  @@index([status, isAvailableNow])
  @@index([status, isRankBooster])
  @@index([status, createdAt(sort: Desc)])
  @@index([userId])
  @@index([inviteCode])
}

model Customer {
  id                      String                    @id @default(cuid())
  name                    String
  birthday                DateTime
  phone                   String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  lineId                  String?                   @unique
  userId                  String                    @unique
  violationCount          Int                       @default(0)
  violations              Json? // 違規詳情陣列 [{time, reason, bookingId}]
  bookings                Booking[]
  multiPlayerBookings     MultiPlayerBooking[]
  user                    User                      @relation(fields: [userId], references: [id])
  FavoritePartner         FavoritePartner[]
  GroupBookingParticipant GroupBookingParticipant[]
  GroupBookingReview      GroupBookingReview[]
  orders                  Order[]

  @@index([userId])
}

model Schedule {
  id          String   @id @default(cuid())
  partnerId   String
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bookings    Booking?
  partner     Partner  @relation(fields: [partnerId], references: [id])

  @@index([partnerId, date, isAvailable])
  @@index([partnerId, date, startTime])
  @@index([date, isAvailable])
  @@index([date, startTime, endTime])
  @@index([endTime])
}

model Booking {
  id                        String              @id @default(cuid())
  customerId                String
  scheduleId                String              @unique
  status                    BookingStatus       @default(PENDING)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  reminderSent              Boolean             @default(false)
  rejectReason              String?
  discountAmount            Float               @default(0)
  finalAmount               Float
  originalAmount            Float
  promoCode                 String?
  orderNumber               String?
  paymentError              String?
  paymentInfo               Json?
  discordEarlyTextChannelId String?
  discordTextChannelId      String?
  discordVoiceChannelId     String?
  extensionButtonShown      Boolean             @default(false)
  ratingCompleted           Boolean             @default(false)
  textChannelCleaned        Boolean             @default(false)
  partnerResponseDeadline   DateTime?
  isWaitingPartnerResponse  Boolean             @default(false)
  serviceType               String              @default("GAMING")
  groupBookingId            String?
  isGroupBooking            Boolean?
  multiPlayerBookingId      String?
  isMultiPlayerBooking      Boolean?
  customer                  Customer            @relation(fields: [customerId], references: [id])
  groupBooking              GroupBooking?       @relation(fields: [groupBookingId], references: [id])
  multiPlayerBooking        MultiPlayerBooking? @relation(fields: [multiPlayerBookingId], references: [id])
  schedule                  Schedule            @relation(fields: [scheduleId], references: [id])
  orders                    Order[]
  referralEarnings          ReferralEarning[]
  reviews                   Review[]
  chatRoom                  ChatRoom?

  @@index([status])
  @@index([status, createdAt(sort: Desc)])
  @@index([status, updatedAt(sort: Desc)])
  @@index([customerId, status])
  @@index([customerId, createdAt(sort: Desc)])
  @@index([scheduleId, status])
  @@index([multiPlayerBookingId, status])
  @@index([groupBookingId])
}

model Order {
  id         String   @id @default(cuid())
  customerId String
  bookingId  String
  amount     Int
  createdAt  DateTime @default(now())
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])
}

model GroupBooking {
  id                      String                    @id @default(cuid())
  type                    GroupBookingType
  title                   String?
  description             String?
  date                    DateTime
  startTime               DateTime
  endTime                 DateTime
  maxParticipants         Int                       @default(10)
  currentParticipants     Int                       @default(0)
  pricePerPerson          Float?
  totalPrice              Float?
  status                  GroupBookingStatus        @default(ACTIVE)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  initiatorId             String
  initiatorType           String
  games                   String[]                  @default([])
  discordTextChannelId    String?
  discordVoiceChannelId   String?
  bookings                Booking[]
  GroupBookingParticipant GroupBookingParticipant[]
  GroupBookingReview      GroupBookingReview[]
  chatRoom                ChatRoom?

  @@index([status, createdAt(sort: Desc)])
  @@index([date, startTime, endTime])
}

model MultiPlayerBooking {
  id               String                   @id @default(cuid())
  customerId       String
  date             DateTime
  startTime        DateTime
  endTime          DateTime
  games            String[]                 @default([])
  status           MultiPlayerBookingStatus @default(PENDING)
  totalAmount      Float                    @default(0)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  lastAdjustmentAt DateTime? // 最後調整時間
  customer         Customer                 @relation(fields: [customerId], references: [id])
  bookings         Booking[]
  chatRoom         ChatRoom?

  @@index([customerId, status])
  @@index([status, createdAt(sort: Desc)])
  @@index([date, startTime, endTime])
}

model Review {
  id         String    @id @default(cuid())
  bookingId  String
  reviewerId String
  revieweeId String
  rating     Int
  comment    String?
  createdAt  DateTime  @default(now())
  isApproved Boolean   @default(false)
  approvedAt DateTime?
  booking    Booking   @relation(fields: [bookingId], references: [id])
  reviewee   User      @relation("Reviewee", fields: [revieweeId], references: [id])
  reviewer   User      @relation("Reviewer", fields: [reviewerId], references: [id])

  @@index([revieweeId, isApproved])
  @@index([bookingId, reviewerId])
  @@index([rating])
}

model PromoCode {
  id           String        @id @default(cuid())
  code         String        @unique
  type         PromoCodeType
  value        Float
  minimumSpend Float?
  maxUses      Int           @default(-1)
  usedCount    Int           @default(0)
  validFrom    DateTime      @default(now())
  validUntil   DateTime?
  isActive     Boolean       @default(true)
  description  String?
  partnerId    String? // 如果設置，此優惠碼只能用於特定夥伴
  partner      Partner?      @relation(fields: [partnerId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([partnerId])
}

model RankingHistory {
  id            String   @id @default(cuid())
  weekStartDate DateTime // 週的開始日期（週一）
  partnerId     String
  rank          Int // 排名（1-10有獎勵）
  totalMinutes  Int // 該週的總時長（分鐘）
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  partner       Partner  @relation(fields: [partnerId], references: [id])

  @@unique([weekStartDate, partnerId])
  @@index([weekStartDate])
  @@index([partnerId])
  @@index([weekStartDate, rank])
}

model WithdrawalRequest {
  id          String           @id @default(cuid())
  partnerId   String
  amount      Float
  status      WithdrawalStatus @default(PENDING)
  requestedAt DateTime         @default(now())
  processedAt DateTime?
  adminNote   String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  partner     Partner          @relation(fields: [partnerId], references: [id])

  @@index([partnerId, status])
  @@index([partnerId, status, requestedAt(sort: Desc)])
  @@index([partnerId, requestedAt])
}

model PairingRecord {
  id            String   @id @default(cuid())
  user1Id       String
  user2Id       String
  timestamp     DateTime @default(now())
  extendedTimes Int      @default(0)
  duration      Int
  rating        Int?
  comment       String?
  animalName    String
  bookingId     String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ReferralRecord {
  id         String            @id @default(cuid())
  inviterId  String
  inviteeId  String            @unique
  inviteCode String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  earnings   ReferralEarning[]
  invitee    Partner           @relation("Invitee", fields: [inviteeId], references: [id])
  inviter    Partner           @relation("Inviter", fields: [inviterId], references: [id])
}

model ReferralEarning {
  id               String         @id @default(cuid())
  referralRecordId String
  bookingId        String
  amount           Float
  percentage       Float
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  booking          Booking        @relation(fields: [bookingId], references: [id])
  referralRecord   ReferralRecord @relation(fields: [referralRecordId], references: [id])
}

model SecurityLog {
  id        String            @id @default(cuid())
  userId    String
  eventType SecurityEventType
  details   String
  ipAddress String
  userAgent String
  timestamp DateTime          @default(now())
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([eventType, timestamp])
  @@index([ipAddress, timestamp])
}

model FavoritePartner {
  id         String   @id
  customerId String
  partnerId  String
  createdAt  DateTime @default(now())
  Customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  Partner    Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([customerId, partnerId])
  @@index([customerId])
  @@index([customerId, createdAt(sort: Desc)])
  @@index([partnerId])
}

model GroupBookingParticipant {
  id             String            @id
  groupBookingId String
  customerId     String
  partnerId      String?
  status         ParticipantStatus @default(ACTIVE)
  joinedAt       DateTime          @default(now())
  Customer       Customer          @relation(fields: [customerId], references: [id])
  GroupBooking   GroupBooking      @relation(fields: [groupBookingId], references: [id])
  Partner        Partner?          @relation(fields: [partnerId], references: [id])

  @@unique([groupBookingId, customerId])
}

model GroupBookingReview {
  id             String       @id
  groupBookingId String
  reviewerId     String
  rating         Int
  comment        String?
  createdAt      DateTime     @default(now())
  isApproved     Boolean      @default(false)
  GroupBooking   GroupBooking @relation(fields: [groupBookingId], references: [id])
  Customer       Customer     @relation(fields: [reviewerId], references: [id])

  @@unique([groupBookingId, reviewerId])
}

enum UserRole {
  CUSTOMER
  PARTNER
  ADMIN
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  PENDING_PAYMENT
  PAID_WAITING_PARTNER_CONFIRMATION
  PARTNER_ACCEPTED
  PARTNER_REJECTED
  CONFIRMED
  CANCELLED
  COMPLETED
  REJECTED
  COMPLETED_WITH_AMOUNT_MISMATCH
}

enum PromoCodeType {
  PERCENTAGE
  FIXED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum SecurityEventType {
  LOGIN_ATTEMPT
  LOGIN_SUCCESS
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  SUSPICIOUS_ACTIVITY
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  EMAIL_VERIFIED
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
}

enum GroupBookingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  FULL
}

enum MultiPlayerBookingStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum GroupBookingType {
  USER_INITIATED
  PARTNER_INITIATED
}

enum ParticipantStatus {
  ACTIVE
  CANCELLED
  COMPLETED
}

enum IdVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AnnouncementType {
  SYSTEM_NOTICE // 系統通知
  ACTIVITY_NOTICE // 活動公告
  SYSTEM_ANNOUNCEMENT // 系統公告
}

// 聊天室模型（支援一對一和群組）
model ChatRoom {
  id                   String              @id @default(cuid())
  type                 ChatRoomType        @default(ONE_ON_ONE) // ONE_ON_ONE, GROUP
  bookingId            String?             @unique // 關聯到訂單（可選，一對一）
  groupBookingId       String?             @unique // 關聯到群組預約（可選，一對一）
  multiPlayerBookingId String?             @unique // 關聯到多人陪玩（可選）
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  lastMessageAt        DateTime? // 最後訊息時間
  members              ChatRoomMember[]
  messages             ChatMessage[]
  booking              Booking?            @relation(fields: [bookingId], references: [id])
  groupBooking         GroupBooking?       @relation(fields: [groupBookingId], references: [id])
  multiPlayerBooking   MultiPlayerBooking? @relation(fields: [multiPlayerBookingId], references: [id])

  @@index([bookingId, type])
  @@index([groupBookingId])
  @@index([multiPlayerBookingId])
  @@index([lastMessageAt(sort: Desc)])
}

// 聊天室成員
model ChatRoomMember {
  id         String    @id @default(cuid())
  roomId     String
  userId     String
  joinedAt   DateTime  @default(now())
  lastReadAt DateTime? // 最後讀取時間
  isActive   Boolean   @default(true)
  room       ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([userId, isActive])
  @@index([roomId])
}

// 聊天訊息（新模型，支援聊天室）
model ChatMessage {
  id               String               @id @default(cuid())
  roomId           String
  senderId         String
  content          String
  contentType      MessageContentType   @default(TEXT)
  status           MessageStatus        @default(SENT)
  moderationStatus ModerationStatus     @default(PENDING)
  moderationReason String? // 審查原因
  moderationScore  Float? // 審查分數（0-1）
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  room             ChatRoom             @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender           User                 @relation("ChatMessageSender", fields: [senderId], references: [id])
  readReceipts     MessageReadReceipt[]

  @@index([roomId, createdAt(sort: Desc)])
  @@index([senderId, createdAt(sort: Desc)])
  @@index([moderationStatus, createdAt(sort: Desc)])
  @@index([roomId, status])
}

// 訊息已讀回條
model MessageReadReceipt {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
}

// 舊的 Message model（保留用於向後兼容，但新功能使用 ChatMessage）
model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])

  @@index([receiverId, isRead])
  @@index([senderId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String
  type      String   @default("info")
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}

model Announcement {
  id        String           @id @default(cuid())
  title     String
  content   String
  type      AnnouncementType
  isActive  Boolean          @default(true)
  expiresAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  createdBy String // 創建者 ID
  creator   User             @relation("AnnouncementCreator", fields: [createdBy], references: [id])

  @@index([isActive, expiresAt])
  @@index([isActive, expiresAt, createdAt(sort: Desc)])
  @@index([isActive, createdAt(sort: Desc)])
}

// 個人通知系統
model PersonalNotification {
  id          String           @id @default(cuid())
  userId      String // 接收者 ID
  senderId    String // 發送者 ID (管理員)
  title       String
  content     String
  type        NotificationType // 通知類型
  priority    Priority         @default(MEDIUM) // 優先級
  isRead      Boolean          @default(false)
  isImportant Boolean          @default(false) // 重要通知
  expiresAt   DateTime? // 過期時間
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user   User @relation("PersonalNotificationReceiver", fields: [userId], references: [id])
  sender User @relation("PersonalNotificationSender", fields: [senderId], references: [id])

  @@index([userId, isRead])
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, isImportant, createdAt(sort: Desc)])
  @@index([userId, expiresAt])
}

// 管理員私訊系統
model AdminMessage {
  id          String   @id @default(cuid())
  userId      String // 接收者 ID
  adminId     String // 管理員 ID
  content     String
  isRead      Boolean  @default(false)
  isFromAdmin Boolean  @default(true) // true: 管理員發送, false: 用戶回覆
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User @relation("AdminMessageReceiver", fields: [userId], references: [id])
  admin User @relation("AdminMessageSender", fields: [adminId], references: [id])

  @@index([userId, isRead])
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt])
}

// 通知類型枚舉
enum NotificationType {
  WARNING // 警告
  VIOLATION // 違規
  REMINDER // 提醒
  INFO // 一般資訊
  SYSTEM // 系統通知
}

// 優先級枚舉
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// 聊天室類型
enum ChatRoomType {
  ONE_ON_ONE // 一對一
  GROUP // 群組
}

// 訊息內容類型
enum MessageContentType {
  TEXT // 文字
  IMAGE // 圖片（未來擴展）
  SYSTEM // 系統訊息
}

// 訊息狀態
enum MessageStatus {
  SENT // 已發送
  DELIVERED // 已送達
  READ // 已讀
}

// 內容審查狀態
enum ModerationStatus {
  PENDING // 待審查
  APPROVED // 通過
  REJECTED // 拒絕（違規）
  FLAGGED // 標記（可疑，需人工審查）
}
